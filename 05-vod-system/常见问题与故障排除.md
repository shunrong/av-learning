# 常见问题与故障排除

## 一、环境问题

### 问题1: FFmpeg 未找到

**错误现象:**
- 上传视频后一直显示"处理中"
- 服务器控制台报错: `Error: spawn ffmpeg ENOENT`

**原因:** 系统未安装FFmpeg或未添加到PATH环境变量

**解决方案:**

**macOS:**
```bash
# 使用Homebrew安装
brew install ffmpeg

# 验证安装
ffmpeg -version
```

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install ffmpeg

# 验证安装
ffmpeg -version
```

**Windows:**
1. 从 [FFmpeg官网](https://ffmpeg.org/download.html) 下载
2. 解压到某个目录，如 `C:\ffmpeg`
3. 添加 `C:\ffmpeg\bin` 到系统PATH环境变量
4. 重启命令行窗口
5. 验证: `ffmpeg -version`

### 问题2: Node.js 版本过低

**错误现象:**
```bash
SyntaxError: Unexpected token '?'
```

**原因:** Node.js版本低于14.0

**解决方案:**
```bash
# 检查版本
node -v

# 如果版本低于14.0，请升级
# macOS (使用Homebrew)
brew upgrade node

# 或使用nvm管理版本
nvm install 18
nvm use 18
```

### 问题3: 端口被占用

**错误现象:**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决方案:**

**方法1: 更改端口**
编辑 `server/server.js`，修改端口号：
```javascript
const PORT = 3001; // 改为其他端口
```

**方法2: 杀死占用进程**
```bash
# macOS/Linux
lsof -ti:3000 | xargs kill -9

# Windows
netstat -ano | findstr :3000
taskkill /PID <PID号> /F
```

## 二、上传问题

### 问题4: 上传大文件失败

**错误现象:**
- 上传大于500MB的视频失败
- 浏览器显示网络错误

**原因:** Multer默认限制文件大小为500MB

**解决方案:**

修改 `server/routes/upload.js`:
```javascript
const upload = multer({
  storage: storage,
  limits: {
    fileSize: 2 * 1024 * 1024 * 1024 // 改为2GB
  },
  // ...
});
```

**注意:** 上传大文件需要更长时间，建议增加超时设置。

### 问题5: 上传后没有反应

**排查步骤:**

1. **检查浏览器控制台:**
```javascript
// 打开开发者工具(F12) -> Console
// 查看是否有错误信息
```

2. **检查服务器日志:**
服务器终端应该显示上传信息，如果没有，说明请求未到达服务器。

3. **检查文件格式:**
确保上传的是视频文件，支持的格式：mp4, avi, mov, mkv, flv, wmv, webm

4. **检查网络:**
```bash
# 测试服务器是否可访问
curl http://localhost:3000/api/videos
```

### 问题6: 上传中断

**原因:** 网络不稳定或文件过大

**解决方案:**
- 使用稳定的网络连接
- 先上传小文件测试
- 实现分片上传（高级功能，需要自行开发）

## 三、转码问题

### 问题7: 视频一直"处理中"

**排查步骤:**

1. **查看服务器日志:**
服务器控制台应该显示转码进度，如:
```
开始处理视频: xxxxx
FFmpeg转码命令: ...
转码进度: 25%
```

2. **检查FFmpeg是否正常工作:**
```bash
# 手动测试FFmpeg
ffmpeg -i test.mp4 -c copy output.mp4
```

3. **检查磁盘空间:**
```bash
# macOS/Linux
df -h

# Windows
wmic logicaldisk get size,freespace,caption
```

4. **检查视频文件是否损坏:**
```bash
ffmpeg -v error -i video.mp4 -f null -
# 如果有错误会输出
```

**常见原因和解决:**

- **FFmpeg未安装**: 参见问题1
- **磁盘空间不足**: 清理磁盘或更换存储位置
- **视频文件损坏**: 重新上传或使用其他视频
- **转码参数错误**: 检查 `VideoManager.js` 中的FFmpeg命令

### 问题8: 转码很慢

**原因:** 
- 视频文件大
- CPU性能不足
- 未使用硬件加速

**优化方案:**

**1. 使用硬件加速 (推荐)**

修改 `server/VideoManager.js` 中的 `transcodeToHLS` 方法:

**NVIDIA GPU (NVENC):**
```javascript
ffmpeg(videoPath)
  .outputOptions([
    '-hwaccel cuda',           // 使用CUDA加速
    '-c:v h264_nvenc',         // NVIDIA硬件编码器
    '-preset fast',            // 快速预设
    // ... 其他选项
  ])
```

**Intel GPU (Quick Sync):**
```javascript
ffmpeg(videoPath)
  .outputOptions([
    '-hwaccel qsv',            // 使用Quick Sync
    '-c:v h264_qsv',           // Intel硬件编码器
    // ... 其他选项
  ])
```

**Apple Silicon (M1/M2):**
```javascript
ffmpeg(videoPath)
  .outputOptions([
    '-c:v h264_videotoolbox',  // VideoToolbox硬件编码
    // ... 其他选项
  ])
```

**2. 降低转码质量 (快速测试)**
```javascript
ffmpeg(videoPath)
  .outputOptions([
    '-c:v libx264',
    '-preset ultrafast',       // 最快预设（质量较低）
    '-crf 28',                 // 降低质量
    // ... 其他选项
  ])
```

**3. 先测试小视频**
用1-2分钟的短视频测试系统是否正常工作。

### 问题9: HLS转码失败

**错误现象:**
- 服务器报错: `HLS转码失败`
- `media/hls` 目录下没有生成文件

**排查:**

1. **检查HLS输出目录权限:**
```bash
ls -la media/hls/
# 确保有写入权限
chmod -R 755 media/hls/
```

2. **手动测试HLS转码:**
```bash
ffmpeg -i test.mp4 \
  -codec: copy \
  -start_number 0 \
  -hls_time 10 \
  -hls_list_size 0 \
  -f hls \
  test_output.m3u8
```

3. **查看详细错误信息:**
修改 `VideoManager.js`，将FFmpeg debug开启：
```javascript
ffmpeg(videoPath)
  .on('start', (cmd) => {
    console.log('FFmpeg转码命令:', cmd);
  })
  .on('stderr', (stderrLine) => {
    console.log('FFmpeg输出:', stderrLine); // 添加这行
  })
```

## 四、播放问题

### 问题10: HLS视频无法播放

**错误现象:**
- 播放器黑屏
- 控制台报错: `Failed to load resource`

**排查步骤:**

1. **检查HLS文件是否生成:**
```bash
ls media/hls/视频ID/
# 应该看到 playlist.m3u8 和多个 .ts 文件
```

2. **检查M3U8文件内容:**
```bash
cat media/hls/视频ID/playlist.m3u8
```

应该看到类似内容:
```
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXTINF:10.0,
segment0.ts
...
```

3. **检查浏览器控制台网络请求:**
- 打开开发者工具 Network 标签
- 查看是否请求了 .m3u8 和 .ts 文件
- 检查HTTP状态码(应该是200)

4. **检查CORS问题:**
如果看到CORS错误，确认 `server/server.js` 中有:
```javascript
app.use(cors());
```

5. **测试HLS链接:**
在浏览器直接访问:
```
http://localhost:3000/media/hls/视频ID/playlist.m3u8
```

应该能下载或显示M3U8内容。

### 问题11: hls.js 加载失败

**错误现象:**
```
Uncaught ReferenceError: Hls is not defined
```

**原因:** CDN加载失败或网络问题

**解决方案:**

**方法1: 检查网络**
确保能访问 `cdn.jsdelivr.net`

**方法2: 使用备用CDN**
修改 `client/player.html`:
```html
<!-- 原CDN -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<!-- 改为备用CDN -->
<script src="https://unpkg.com/hls.js@latest"></script>
```

**方法3: 本地引入**
下载hls.js到本地:
```bash
cd client
npm install hls.js
# 然后引用本地文件
```

### 问题12: 视频卡顿

**原因:**
- 网络速度慢
- 视频码率太高
- 浏览器性能不足

**解决方案:**

1. **降低视频码率:**
修改 `VideoManager.js` 转码参数:
```javascript
.outputOptions([
  '-b:v 2M',  // 降低视频码率到2Mbps
  '-b:a 128k', // 降低音频码率到128kbps
])
```

2. **减小HLS切片时长:**
```javascript
'-hls_time 6',  // 改为6秒（默认10秒）
```

3. **使用CDN加速** (生产环境)

### 问题13: 音画不同步

**原因:** 转码参数问题

**解决方案:**

修改 `VideoManager.js`:
```javascript
ffmpeg(videoPath)
  .outputOptions([
    '-vsync 1',          // 添加视频同步
    '-async 1',          // 添加音频同步
    '-c:v libx264',
    '-c:a aac',
    // ... 其他选项
  ])
```

## 五、删除问题

### 问题14: 删除视频失败

**排查:**

1. **检查文件权限:**
```bash
ls -la media/videos/
ls -la media/hls/
```

2. **检查是否有其他进程占用文件:**
```bash
# macOS/Linux
lsof | grep 视频文件名

# Windows
handle.exe 视频文件名
```

3. **查看服务器错误日志**

## 六、性能问题

### 问题15: 多个视频同时转码导致服务器卡顿

**原因:** 多个FFmpeg进程同时运行消耗大量CPU

**解决方案:**

**实现转码队列 (高级功能):**

```javascript
// 创建简单的队列
class TranscodeQueue {
  constructor(concurrency = 2) {
    this.queue = [];
    this.running = 0;
    this.concurrency = concurrency; // 同时处理的任务数
  }

  async add(task) {
    return new Promise((resolve, reject) => {
      this.queue.push({ task, resolve, reject });
      this.process();
    });
  }

  async process() {
    if (this.running >= this.concurrency || this.queue.length === 0) {
      return;
    }

    this.running++;
    const { task, resolve, reject } = this.queue.shift();

    try {
      const result = await task();
      resolve(result);
    } catch (error) {
      reject(error);
    } finally {
      this.running--;
      this.process();
    }
  }
}

// 使用队列
const transcodeQueue = new TranscodeQueue(2); // 最多同时转码2个视频
await transcodeQueue.add(() => this.processVideo(videoId, videoPath));
```

### 问题16: 磁盘空间不足

**监控磁盘使用:**

```javascript
const fs = require('fs');
const { execSync } = require('child_process');

function checkDiskSpace() {
  try {
    const result = execSync('df -h .').toString();
    console.log('磁盘使用情况:', result);
    // 解析并检查是否低于阈值
  } catch (error) {
    console.error('检查磁盘空间失败:', error);
  }
}
```

**定期清理:**
- 删除旧视频
- 只保留HLS格式，删除原始视频
- 实现视频过期机制

## 七、开发调试

### 调试技巧1: 启用详细日志

修改 `VideoManager.js`:
```javascript
// 添加详细日志
console.log('[DEBUG] 开始处理视频:', videoId);
console.log('[DEBUG] 视频路径:', videoPath);
console.log('[DEBUG] FFmpeg命令:', command);
```

### 调试技巧2: 使用nodemon自动重启

```bash
npm run dev
# 修改代码后自动重启
```

### 调试技巧3: 单独测试FFmpeg

```bash
# 创建测试脚本 test-ffmpeg.sh
ffmpeg -i test.mp4 \
  -codec: copy \
  -start_number 0 \
  -hls_time 10 \
  -hls_list_size 0 \
  -f hls \
  output.m3u8

# 运行测试
bash test-ffmpeg.sh
```

### 调试技巧4: 使用Chrome开发者工具

1. **Network标签:** 查看所有网络请求
2. **Console标签:** 查看JavaScript错误
3. **Application标签:** 查看存储、ServiceWorker等
4. **Performance标签:** 分析性能瓶颈

## 八、部署问题

### 问题17: 生产环境部署

**注意事项:**

1. **环境变量:**
```bash
# 创建 .env 文件
NODE_ENV=production
PORT=3000
MEDIA_PATH=/var/www/media
```

2. **使用PM2管理进程:**
```bash
npm install -g pm2
pm2 start server/server.js --name vod-system
pm2 startup
pm2 save
```

3. **配置Nginx反向代理:**
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location /media/ {
        alias /path/to/media/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
```

4. **使用对象存储 (OSS/S3):**
将媒体文件存储到云端，减轻服务器压力。

## 九、获取帮助

如果以上方法都无法解决问题：

1. **查看服务器完整日志:**
```bash
# 启动时输出到文件
npm start > server.log 2>&1
```

2. **检查系统资源:**
```bash
# CPU和内存使用
top

# macOS
Activity Monitor

# Windows
任务管理器
```

3. **测试FFmpeg安装:**
```bash
ffmpeg -version
ffmpeg -formats
ffmpeg -codecs
```

4. **提供详细信息:**
- 操作系统和版本
- Node.js版本
- FFmpeg版本
- 完整的错误信息
- 服务器日志
- 视频文件信息（格式、大小、时长）

## 十、最佳实践

### 开发建议:

1. **从小文件开始测试** (10-50MB)
2. **一步一步验证** (上传→转码→播放)
3. **保留日志** 便于排查问题
4. **定期备份** 重要数据
5. **监控资源使用** (CPU、内存、磁盘)

### 性能建议:

1. **使用硬件加速转码**
2. **实现转码队列**
3. **CDN加速分发**
4. **定期清理临时文件**
5. **数据库存储元数据** (生产环境)

### 安全建议:

1. **文件类型验证**
2. **文件大小限制**
3. **防盗链机制**
4. **用户认证授权**
5. **定期更新依赖**

---

遇到问题不要慌，按照本文档逐步排查，大部分问题都能解决！🎉

