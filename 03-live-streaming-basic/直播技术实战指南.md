# ç›´æ’­æŠ€æœ¯å®æˆ˜æŒ‡å—

> ä»æ•°æ®æµè½¬åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œä»æ•…éšœå¤„ç†åˆ°æ¶æ„è®¾è®¡çš„å®æˆ˜ç»éªŒ

## ğŸ“š ç›®å½•

1. [æ•°æ®æµè½¬å…¨è¿‡ç¨‹](#æ•°æ®æµè½¬å…¨è¿‡ç¨‹)
2. [å»¶è¿Ÿä¼˜åŒ–å®æˆ˜](#å»¶è¿Ÿä¼˜åŒ–å®æˆ˜)
3. [æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§](#æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§)
4. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
5. [æ¶æ„è®¾è®¡å®æˆ˜](#æ¶æ„è®¾è®¡å®æˆ˜)

---

## æ•°æ®æµè½¬å…¨è¿‡ç¨‹

### ä¸»æ’­ç«¯ï¼šä»æ‘„åƒå¤´åˆ°ç½‘ç»œ

#### 1. éŸ³è§†é¢‘é‡‡é›†

**è§†é¢‘é‡‡é›†é“¾è·¯**ï¼š
```
æ‘„åƒå¤´ CMOS ä¼ æ„Ÿå™¨
    â†“
ç¡¬ä»¶ ISP (Image Signal Processor)
â”œâ”€â”€ å»å™ª
â”œâ”€â”€ ç™½å¹³è¡¡
â”œâ”€â”€ æ›å…‰æ§åˆ¶
â””â”€â”€ é¢œè‰²æ ¡æ­£
    â†“
åŸå§‹æ ¼å¼ (Bayer/YUV)
    â†“
æ“ä½œç³»ç»Ÿ API
â”œâ”€â”€ iOS: AVFoundation (AVCaptureSession)
â”œâ”€â”€ Android: Camera2 API
â”œâ”€â”€ Windows: DirectShow/MediaFoundation
â”œâ”€â”€ Linux: V4L2 (Video4Linux2)
â””â”€â”€ Web: getUserMedia()
    â†“
å†…å­˜ä¸­çš„è§†é¢‘å¸§
æ ¼å¼ï¼šYUV420P (I420)
å¤§å°ï¼š1920Ã—1080Ã—1.5 = 3MB/å¸§
é¢‘ç‡ï¼š30fps = 90MB/ç§’ï¼ˆæœªå‹ç¼©ï¼ï¼‰
```

**ä¸ºä»€ä¹ˆç”¨ YUV è€Œä¸æ˜¯ RGBï¼Ÿ**
```
RGBï¼ˆè®¡ç®—æœºå›¾å½¢ï¼‰ï¼š
â”œâ”€â”€ æ¯åƒç´ 3å­—èŠ‚ï¼ˆR + G + Bï¼‰
â”œâ”€â”€ 1920Ã—1080 = 6MB/å¸§
â””â”€â”€ é€‚åˆæ˜¾ç¤ºï¼Œä¸é€‚åˆå‹ç¼©

YUVï¼ˆè§†é¢‘å¤„ç†ï¼‰ï¼š
â”œâ”€â”€ Yï¼šäº®åº¦ï¼ˆ1å­—èŠ‚ï¼‰
â”œâ”€â”€ Uã€Vï¼šè‰²åº¦ï¼ˆå„0.25å­—èŠ‚ï¼Œé‡‡æ ·ï¼‰
â”œâ”€â”€ 1920Ã—1080Ã—1.5 = 3MB/å¸§ï¼ˆèŠ‚çœ50%ï¼‰
â””â”€â”€ é€‚åˆå‹ç¼©ï¼ˆäººçœ¼å¯¹è‰²åº¦ä¸æ•æ„Ÿï¼‰

YUV420P é‡‡æ ·ï¼š
Y: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
U: â–ˆâ–ˆ      â†’ æ¯4ä¸ªåƒç´ å…±äº«1ä¸ªU
V: â–ˆâ–ˆ      â†’ æ¯4ä¸ªåƒç´ å…±äº«1ä¸ªV
```

**éŸ³é¢‘é‡‡é›†é“¾è·¯**ï¼š
```
éº¦å…‹é£
    â†“
ADC (æ¨¡æ‹Ÿæ•°å­—è½¬æ¢)
    â†“
PCM (Pulse Code Modulation)
â”œâ”€â”€ é‡‡æ ·ç‡ï¼š48000 Hz (æ¯ç§’48000ä¸ªæ ·æœ¬)
â”œâ”€â”€ ä½æ·±ï¼š16 bit (æ¯æ ·æœ¬2å­—èŠ‚)
â”œâ”€â”€ å£°é“ï¼š2 (ç«‹ä½“å£°)
â””â”€â”€ ç ç‡ï¼š48000 Ã— 2 Ã— 2 = 192KB/ç§’
    â†“
æ“ä½œç³»ç»Ÿ API
â”œâ”€â”€ iOS: AVAudioEngine
â”œâ”€â”€ Android: AudioRecord
â”œâ”€â”€ Windows: WASAPI
â”œâ”€â”€ Linux: ALSA/PulseAudio
â””â”€â”€ Web: getUserMedia()
```

**å®é™…ä»£ç ç¤ºä¾‹ï¼ˆWebï¼‰**ï¼š
```javascript
// è·å–æ‘„åƒå¤´å’Œéº¦å…‹é£
const stream = await navigator.mediaDevices.getUserMedia({
  video: {
    width: { ideal: 1920 },
    height: { ideal: 1080 },
    frameRate: { ideal: 30 },
    facingMode: 'user'  // å‰ç½®æ‘„åƒå¤´
  },
  audio: {
    sampleRate: 48000,
    channelCount: 2,
    echoCancellation: true,  // å›å£°æ¶ˆé™¤
    noiseSuppression: true,  // é™å™ª
    autoGainControl: true    // è‡ªåŠ¨å¢ç›Š
  }
});

// è·å–åŸå§‹è§†é¢‘å¸§ï¼ˆç”¨äºé¢„å¤„ç†ï¼‰
const video = document.querySelector('video');
video.srcObject = stream;

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

function captureFrame() {
  ctx.drawImage(video, 0, 0);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  // imageData.data: RGBA æ ¼å¼çš„åŸå§‹åƒç´ 
  
  // å¦‚æœéœ€è¦ YUVï¼Œè¦è½¬æ¢ï¼š
  const yuv = rgbaToYuv420(imageData.data);
  
  requestAnimationFrame(captureFrame);
}
```

---

#### 2. å‰å¤„ç†ï¼ˆå¯é€‰ï¼‰

**ç¾é¢œç®—æ³•**ï¼š
```
ç¾é¢œæµæ°´çº¿ï¼š

åŸå§‹å¸§ (YUV)
    â†“
1. äººè„¸æ£€æµ‹ (Face Detection)
   â””â”€â”€ ç®—æ³•ï¼šHaar Cascade / MTCNN / MediaPipe
    â†“
2. äººè„¸å…³é”®ç‚¹å®šä½ (Facial Landmarks)
   â””â”€â”€ 68ç‚¹æ¨¡å‹ï¼šçœ¼ç›ã€é¼»å­ã€å˜´å·´
    â†“
3. çš®è‚¤æ£€æµ‹ (Skin Detection)
   â””â”€â”€ YUV è‰²å½©ç©ºé—´é˜ˆå€¼
    â†“
4. ç£¨çš® (Skin Smoothing)
   â”œâ”€â”€ åŒè¾¹æ»¤æ³¢ (Bilateral Filter)
   â””â”€â”€ ä¿ç•™è¾¹ç¼˜ï¼Œæ¨¡ç³Šçš®è‚¤
    â†“
5. ç¾ç™½ (Skin Whitening)
   â””â”€â”€ æå‡ Y é€šé“äº®åº¦
    â†“
6. ç˜¦è„¸/å¤§çœ¼ (Face Warping)
   â””â”€â”€ Mesh Warping ç®—æ³•
    â†“
å¤„ç†åçš„å¸§

æ€§èƒ½ï¼š
â”œâ”€â”€ CPU: 30ms/å¸§ï¼ˆå•æ ¸ï¼‰â†’ æ— æ³•å®æ—¶
â”œâ”€â”€ GPU (OpenGL/Metal): 5ms/å¸§ âœ…
â””â”€â”€ NPU (ç¥ç»ç½‘ç»œ): 3ms/å¸§ âœ…
```

**å…¶ä»–å‰å¤„ç†**ï¼š
```
1. é™å™ª (Denoise)ï¼š
   â”œâ”€â”€ æ—¶åŸŸé™å™ªï¼ˆå‚è€ƒå‰åå¸§ï¼‰
   â””â”€â”€ ç©ºåŸŸé™å™ªï¼ˆé«˜æ–¯æ¨¡ç³Šï¼‰

2. é”åŒ– (Sharpen)ï¼š
   â””â”€â”€ Unsharp Mask

3. è‰²å½©å¢å¼º (Color Enhancement)ï¼š
   â”œâ”€â”€ é¥±å’Œåº¦è°ƒæ•´
   â””â”€â”€ å¯¹æ¯”åº¦è°ƒæ•´

4. è™šæ‹ŸèƒŒæ™¯ (Virtual Background)ï¼š
   â”œâ”€â”€ äººåƒåˆ†å‰²ï¼ˆæ·±åº¦å­¦ä¹ ï¼‰
   â”œâ”€â”€ æ›¿æ¢èƒŒæ™¯
   â””â”€â”€ è¾¹ç¼˜èåˆ

5. æ°´å° (Watermark)ï¼š
   â””â”€â”€ Alpha æ··åˆ
```

**æ€§èƒ½æŒ‘æˆ˜**ï¼š
```
å®æ—¶æ€§è¦æ±‚ï¼š
â”œâ”€â”€ 30fps â†’ æ¯å¸§å¤„ç†æ—¶é—´ < 33ms
â”œâ”€â”€ 60fps â†’ æ¯å¸§å¤„ç†æ—¶é—´ < 16ms
â””â”€â”€ åŒ…æ‹¬ï¼šé‡‡é›† + å‰å¤„ç† + ç¼–ç 

ä¼˜åŒ–ç­–ç•¥ï¼š
1. GPU åŠ é€Ÿï¼ˆOpenGL/Metal/Vulkanï¼‰
2. å¤šçº¿ç¨‹ï¼ˆé‡‡é›†/å¤„ç†/ç¼–ç å¹¶è¡Œï¼‰
3. é™ä½åˆ†è¾¨ç‡ï¼ˆå‰å¤„ç†ç”¨720pï¼Œç¼–ç ç”¨1080pï¼‰
4. è·³å¸§å¤„ç†ï¼ˆåªå¤„ç†å…³é”®å¸§ï¼‰
```

---

#### 3. è§†é¢‘ç¼–ç 

**H.264 ç¼–ç æµç¨‹**ï¼š
```
YUV å¸§åºåˆ—
    â†“
å®å—åˆ’åˆ† (Macroblock)
â”œâ”€â”€ å°† 16Ã—16 åƒç´ ä½œä¸ºä¸€ä¸ªå•å…ƒ
â””â”€â”€ 1920Ã—1080 = 120Ã—68 = 8160ä¸ªå®å—
    â†“
å¸§ç±»å‹å†³ç­–
â”œâ”€â”€ I å¸§ (Intra)ï¼šå®Œæ•´å¸§ï¼ˆæ¯GOPä¸€ä¸ªï¼‰
â”œâ”€â”€ P å¸§ (Predictive)ï¼šå‚è€ƒå‰ä¸€å¸§
â””â”€â”€ B å¸§ (Bidirectional)ï¼šå‚è€ƒå‰åå¸§ï¼ˆç›´æ’­å°‘ç”¨ï¼‰
    â†“
è¿åŠ¨ä¼°è®¡ (Motion Estimation)
â”œâ”€â”€ åœ¨å‚è€ƒå¸§ä¸­æœç´¢ç›¸ä¼¼å®å—
â”œâ”€â”€ ç”Ÿæˆè¿åŠ¨çŸ¢é‡ (Motion Vector)
â””â”€â”€ ç®—æ³•ï¼šå…¨æœç´¢/é’»çŸ³æœç´¢/EPZS
    â†“
è¿åŠ¨è¡¥å¿ (Motion Compensation)
â”œâ”€â”€ ç”¨è¿åŠ¨çŸ¢é‡é¢„æµ‹å½“å‰å®å—
â””â”€â”€ è®¡ç®—æ®‹å·® (Residual)
    â†“
å˜æ¢ (Transform)
â”œâ”€â”€ DCT (Discrete Cosine Transform)
â””â”€â”€ å°†ç©ºåŸŸä¿¡å·è½¬ä¸ºé¢‘åŸŸ
    â†“
é‡åŒ– (Quantization)
â”œâ”€â”€ ç”¨ QP (Quantization Parameter) æ§åˆ¶è´¨é‡
â”œâ”€â”€ QP è¶Šå¤§ â†’ è´¨é‡è¶Šä½ â†’ ç ç‡è¶Šä½
â””â”€â”€ è¿™ä¸€æ­¥ä¼šä¸¢å¤±ä¿¡æ¯ï¼ˆæœ‰æŸå‹ç¼©ï¼‰
    â†“
ç†µç¼–ç  (Entropy Coding)
â”œâ”€â”€ CAVLC / CABAC
â””â”€â”€ æ— æŸå‹ç¼©ï¼ˆç±»ä¼¼ zipï¼‰
    â†“
NAL Units (Network Abstraction Layer)
â”œâ”€â”€ SPS (Sequence Parameter Set)ï¼šè§†é¢‘å…¨å±€å‚æ•°
â”œâ”€â”€ PPS (Picture Parameter Set)ï¼šå›¾åƒå‚æ•°
â”œâ”€â”€ IDR (Iå¸§)
â”œâ”€â”€ Non-IDR (P/Bå¸§)
â””â”€â”€ SEI (è¡¥å……ä¿¡æ¯)
    â†“
H.264 ç æµ
```

**ç¼–ç å‚æ•°çš„å½±å“**ï¼š

**1. GOP å¤§å°**
```
GOP = 30ï¼ˆ1ç§’ï¼‰ï¼š
I P P P P P ... P I P P P ...
â”‚â†â”€â”€â”€â”€â”€â”€ 30å¸§ â”€â”€â”€â”€â†’â”‚

ä¼˜ç‚¹ï¼š
âœ… å‹ç¼©ç‡é«˜ï¼ˆæ›´å¤š P å¸§ï¼‰
âœ… å¸¦å®½èŠ‚çœ

ç¼ºç‚¹ï¼š
âŒ Seek æ…¢ï¼ˆéœ€è¦ä» I å¸§å¼€å§‹ï¼‰
âŒ æ–°è§‚ä¼—è¿›å…¥å»¶è¿Ÿé«˜
âŒ èŠ±å±æ—¶é—´é•¿ï¼ˆä¸¢äº† I å¸§ï¼‰

GOP = 15ï¼ˆ0.5ç§’ï¼‰ï¼š
I P P ... P I P P ... P I
â”‚â†â”€ 15å¸§ â”€â†’â”‚

é€‚åˆç›´æ’­ï¼š
âœ… æ–°è§‚ä¼—å¿«é€Ÿçœ‹åˆ°ç”»é¢
âœ… èŠ±å±æ¢å¤å¿«

æ¨èå€¼ï¼š
â”œâ”€â”€ è¶…ä½å»¶è¿Ÿç›´æ’­ï¼šGOP = 15-30
â”œâ”€â”€ æ ‡å‡†ç›´æ’­ï¼šGOP = 60-120
â””â”€â”€ ç‚¹æ’­ï¼šGOP = 120-250
```

**2. ç ç‡æ§åˆ¶**
```
CBR (Constant Bitrate)ï¼š
ç›®æ ‡ç ç‡ï¼š4000 kbps
å®é™…ç ç‡ï¼š3900-4100 kbpsï¼ˆæ’å®šï¼‰

ä¼˜ç‚¹ï¼š
âœ… å¸¦å®½å¯é¢„æµ‹ï¼ˆé€‚åˆç›´æ’­ï¼‰
âœ… æœåŠ¡å™¨ç¨³å®š

ç¼ºç‚¹ï¼š
âŒ é™æ­¢ç”»é¢æµªè´¹å¸¦å®½
âŒ å¿«é€Ÿè¿åŠ¨ç”»é¢è´¨é‡å·®

VBR (Variable Bitrate)ï¼š
ç›®æ ‡è´¨é‡ï¼šCRF = 23
å®é™…ç ç‡ï¼š1000-8000 kbpsï¼ˆæ³¢åŠ¨ï¼‰

ä¼˜ç‚¹ï¼š
âœ… è´¨é‡æ’å®š
âœ… å¹³å‡ç ç‡ä½

ç¼ºç‚¹ï¼š
âŒ å¸¦å®½ä¸å¯é¢„æµ‹ï¼ˆä¸é€‚åˆç›´æ’­ï¼‰

ABR (Average Bitrate)ï¼š
ç›®æ ‡å¹³å‡ç ç‡ï¼š4000 kbps
å®é™…ç ç‡ï¼š2000-6000 kbpsï¼ˆæœ‰é™æ³¢åŠ¨ï¼‰

æŠ˜ä¸­æ–¹æ¡ˆï¼š
âœ… è´¨é‡è¾ƒå¥½
âœ… å¸¦å®½ç›¸å¯¹ç¨³å®š
```

**3. é¢„è®¾ (Preset)**
```
FFmpeg é¢„è®¾ï¼š
ultrafast < superfast < veryfast < faster < fast < 
medium < slow < slower < veryslow

                ç¼–ç é€Ÿåº¦    å‹ç¼©ç‡    è´¨é‡
ultrafast       æå¿«       ä½        å·®
veryfast        å¾ˆå¿«       è¾ƒä½      è¾ƒå·®
medium          ä¸­ç­‰       ä¸­ç­‰      ä¸­ç­‰
slow            æ…¢         é«˜        å¥½
veryslow        ææ…¢       æé«˜      æå¥½

ç›´æ’­æ¨èï¼š
â”œâ”€â”€ ç§»åŠ¨ç«¯æ¨æµï¼šveryfastï¼ˆCPUå—é™ï¼‰
â”œâ”€â”€ PCç«¯æ¨æµï¼šmedium
â””â”€â”€ ä¸“ä¸šè®¾å¤‡ï¼šslowï¼ˆç¡¬ä»¶ç¼–ç ï¼‰

ç¡¬ä»¶ç¼–ç ï¼š
â”œâ”€â”€ Intel Quick Sync (QSV)
â”œâ”€â”€ NVIDIA NVENC
â”œâ”€â”€ AMD VCE
â””â”€â”€ Apple VideoToolbox

ç¡¬ä»¶ vs è½¯ä»¶ï¼š
           é€Ÿåº¦    è´¨é‡    åŠŸè€—
ç¡¬ä»¶ç¼–ç    æå¿«    è‰¯å¥½    ä½
è½¯ä»¶ç¼–ç    æ…¢      ä¼˜ç§€    é«˜
```

**å®é™…ç¼–ç ç¤ºä¾‹**ï¼š
```bash
# FFmpeg è½¯ä»¶ç¼–ç ï¼ˆx264ï¼‰
ffmpeg -f avfoundation -i "0:0" \
  -c:v libx264 \           # è½¯ä»¶ç¼–ç 
  -preset veryfast \       # é€Ÿåº¦ä¼˜å…ˆ
  -tune zerolatency \      # ä½å»¶è¿Ÿä¼˜åŒ–
  -profile:v baseline \    # å…¼å®¹æ€§å¥½
  -level 3.1 \             # H.264 Level
  -g 30 \                  # GOP 30å¸§
  -keyint_min 30 \         # æœ€å°GOP
  -sc_threshold 0 \        # ç¦ç”¨åœºæ™¯åˆ‡æ¢ï¼ˆä¿æŒå›ºå®šGOPï¼‰
  -b:v 4000k \             # ç›®æ ‡ç ç‡ 4Mbps
  -maxrate 4000k \         # æœ€å¤§ç ç‡
  -bufsize 8000k \         # ç¼“å†²åŒºå¤§å°
  -pix_fmt yuv420p \       # åƒç´ æ ¼å¼
  -c:a aac \               # éŸ³é¢‘ AAC
  -b:a 128k \              # éŸ³é¢‘ç ç‡
  -ar 48000 \              # éŸ³é¢‘é‡‡æ ·ç‡
  -f flv \                 # è¾“å‡º FLV
  rtmp://server/live/stream

# ç¡¬ä»¶ç¼–ç ï¼ˆNVENCï¼‰
ffmpeg -f avfoundation -i "0:0" \
  -c:v h264_videotoolbox \ # macOS ç¡¬ä»¶ç¼–ç 
  -b:v 4000k \
  -maxrate 4000k \
  -bufsize 8000k \
  -realtime 1 \            # å®æ—¶ç¼–ç 
  -f flv \
  rtmp://server/live/stream
```

---

#### 4. éŸ³é¢‘ç¼–ç 

**AAC ç¼–ç æµç¨‹**ï¼š
```
PCM éŸ³é¢‘
    â†“
åˆ†å¸§ (Frame)
â””â”€â”€ 1024 ä¸ªæ ·æœ¬ä¸ºä¸€å¸§ï¼ˆAAC-LCï¼‰
    â†“
çª—å‡½æ•° (Windowing)
â””â”€â”€ é¿å…é¢‘è°±æ³„æ¼
    â†“
MDCT (Modified Discrete Cosine Transform)
â””â”€â”€ æ—¶åŸŸ â†’ é¢‘åŸŸ
    â†“
å¿ƒç†å£°å­¦æ¨¡å‹ (Psychoacoustic Model)
â”œâ”€â”€ åˆ†æäººè€³æ©è”½æ•ˆåº”
â”œâ”€â”€ é¢‘åŸŸæ©è”½ï¼ˆå¼ºéŸ³æ©è”½å¼±éŸ³ï¼‰
â””â”€â”€ æ—¶åŸŸæ©è”½ï¼ˆç¬æ€å£°éŸ³å‰åï¼‰
    â†“
é‡åŒ– (Quantization)
â”œâ”€â”€ æ ¹æ®æ©è”½é˜ˆå€¼åˆ†é…æ¯”ç‰¹
â””â”€â”€ äººè€³ä¸æ•æ„Ÿçš„é¢‘ç‡ç”¨æ›´å°‘æ¯”ç‰¹
    â†“
éœå¤«æ›¼ç¼–ç  (Huffman Coding)
â””â”€â”€ æ— æŸå‹ç¼©
    â†“
AAC å¸§
```

**AAC é…ç½®å‚æ•°**ï¼š
```
Profileï¼š
â”œâ”€â”€ AAC-LC (Low Complexity)ï¼šæœ€å¸¸ç”¨ï¼Œå…¼å®¹æ€§å¥½
â”œâ”€â”€ HE-AAC (High Efficiency)ï¼šä½ç ç‡ï¼Œé€‚åˆè¯­éŸ³
â”œâ”€â”€ HE-AAC v2ï¼šæ›´ä½ç ç‡ï¼Œé€‚åˆå•å£°é“
â””â”€â”€ AAC-LD (Low Delay)ï¼šä½å»¶è¿Ÿï¼Œé€‚åˆå®æ—¶é€šä¿¡

é‡‡æ ·ç‡ï¼š
â”œâ”€â”€ 48000 Hzï¼šä¸“ä¸šéŸ³é¢‘
â”œâ”€â”€ 44100 Hzï¼šCD éŸ³è´¨
â”œâ”€â”€ 32000 Hzï¼šå¹¿æ’­
â””â”€â”€ 16000 Hzï¼šè¯­éŸ³

ç ç‡æ¨èï¼š
â”œâ”€â”€ éŸ³ä¹ç›´æ’­ï¼š192 kbps (ç«‹ä½“å£°)
â”œâ”€â”€ æ¸¸æˆç›´æ’­ï¼š128 kbps (ç«‹ä½“å£°)
â”œâ”€â”€ è¯­éŸ³ç›´æ’­ï¼š64 kbps (å•å£°é“)
â””â”€â”€ è§†é¢‘ä¼šè®®ï¼š32 kbps (å•å£°é“)
```

**éŸ³é¢‘å‰å¤„ç†**ï¼š
```
åŸå§‹ PCM
    â†“
1. è‡ªåŠ¨å¢ç›Šæ§åˆ¶ (AGC)
   â””â”€â”€ è‡ªåŠ¨è°ƒæ•´éŸ³é‡ï¼ˆé˜²æ­¢è¿‡å¤§/è¿‡å°ï¼‰
    â†“
2. å›å£°æ¶ˆé™¤ (AEC - Acoustic Echo Cancellation)
   â””â”€â”€ æ¶ˆé™¤æ‰¬å£°å™¨å›å£°ï¼ˆé‡è¦ï¼ï¼‰
    â†“
3. é™å™ª (ANS - Audio Noise Suppression)
   â””â”€â”€ å»é™¤èƒŒæ™¯å™ªéŸ³
    â†“
4. å‡è¡¡å™¨ (Equalizer)
   â””â”€â”€ è°ƒæ•´é¢‘ç‡å“åº”
    â†“
5. å‹ç¼©å™¨ (Compressor)
   â””â”€â”€ åŠ¨æ€èŒƒå›´å‹ç¼©ï¼ˆè®©å£°éŸ³æ›´"å“äº®"ï¼‰
    â†“
ç¼–ç 

Web Audio API ç¤ºä¾‹ï¼š
const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);

// å‡è¡¡å™¨
const eq = audioContext.createBiquadFilter();
eq.type = 'highshelf';
eq.frequency.value = 3000;
eq.gain.value = 6;

// å‹ç¼©å™¨
const compressor = audioContext.createDynamicsCompressor();
compressor.threshold.value = -24;
compressor.knee.value = 30;
compressor.ratio.value = 12;

// è¿æ¥
source.connect(eq).connect(compressor).connect(audioContext.destination);
```

---

#### 5. å°è£…ä¸æ¨æµ

**FLV å°è£…**ï¼š
```
ç¼–ç åçš„æ•°æ®ï¼š
â”œâ”€â”€ Video: H.264 NALU
â””â”€â”€ Audio: AAC Frame

å°è£…æˆ FLV Tagï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLV Header (9å­—èŠ‚)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Previous Tag Size = 0â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Script Tag           â”‚
â”‚ (onMetaData)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Previous Tag Size    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Video Tag            â”‚
â”‚ (SPS/PPS)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Audio Tag            â”‚
â”‚ (AudioSpecificConfig)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Video Tag (Iå¸§)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Audio Tag            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Video Tag (På¸§)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—¶é—´æˆ³è®¡ç®—ï¼š
Video Timestamp (ms) = frameCount / fps * 1000
Audio Timestamp (ms) = sampleCount / sampleRate * 1000

éŸ³è§†é¢‘åŒæ­¥ï¼š
DTS (Decode Time Stamp)ï¼šè§£ç æ—¶é—´
PTS (Presentation Time Stamp)ï¼šæ˜¾ç¤ºæ—¶é—´
CompositionTime = PTS - DTSï¼ˆBå¸§ä¼šç”¨åˆ°ï¼‰
```

**RTMP æ¨æµ**ï¼š
```
TCP è¿æ¥
    â†“
RTMP æ¡æ‰‹ï¼ˆC0/C1/C2, S0/S1/S2ï¼‰
    â†“
connect("rtmp://server/app")
    â†“
createStream() â†’ è·å¾— streamId
    â†“
publish("streamName")
    â†“
å‘é€ FLV Tagï¼ˆè½¬æ¢ä¸º RTMP Chunkï¼‰

FLV Tag â†’ RTMP Chunk è½¬æ¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLV Tag                â”‚
â”‚ â”œâ”€â”€ Tag Type (9=Video) â”‚
â”‚ â”œâ”€â”€ Data Size          â”‚
â”‚ â”œâ”€â”€ Timestamp          â”‚
â”‚ â””â”€â”€ Tag Data           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ è½¬æ¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RTMP Chunk             â”‚
â”‚ â”œâ”€â”€ Basic Header       â”‚
â”‚ â”‚   â””â”€â”€ Chunk Stream IDâ”‚
â”‚ â”œâ”€â”€ Message Header     â”‚
â”‚ â”‚   â”œâ”€â”€ Timestamp      â”‚
â”‚ â”‚   â”œâ”€â”€ Message Length â”‚
â”‚ â”‚   â”œâ”€â”€ Message Type   â”‚
â”‚ â”‚   â””â”€â”€ Message Stream â”‚
â”‚ â””â”€â”€ Chunk Data         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†å—ç¤ºä¾‹ï¼š
FLV Video Tag: 100KB
Chunk Size: 4096 bytes
ç»“æœï¼šåˆ†æˆ 25 ä¸ª Chunk

Chunk 1: Type 0ï¼ˆå®Œæ•´å¤´ï¼‰+ 4096å­—èŠ‚æ•°æ®
Chunk 2: Type 3ï¼ˆæ— å¤´ï¼‰+ 4096å­—èŠ‚æ•°æ®
Chunk 3: Type 3ï¼ˆæ— å¤´ï¼‰+ 4096å­—èŠ‚æ•°æ®
...
Chunk 25: Type 3ï¼ˆæ— å¤´ï¼‰+ 1024å­—èŠ‚æ•°æ®
```

**æ¨æµæ€§èƒ½ä¼˜åŒ–**ï¼š
```
1. TCP ä¼˜åŒ–ï¼š
   â”œâ”€â”€ ç¦ç”¨ Nagle ç®—æ³•ï¼ˆTCP_NODELAYï¼‰
   â”œâ”€â”€ å¢å¤§å‘é€ç¼“å†²åŒºï¼ˆSO_SNDBUFï¼‰
   â””â”€â”€ è®¾ç½® TCP keepalive

2. ç½‘ç»œè‡ªé€‚åº”ï¼š
   â”œâ”€â”€ ç›‘æ§ TCP å‘é€ç¼“å†²åŒºä½¿ç”¨ç‡
   â”œâ”€â”€ å¦‚æœå †ç§¯ > 50% â†’ é™ä½ç ç‡
   â””â”€â”€ å¦‚æœå †ç§¯ < 10% â†’ å¯ä»¥å‡ç ç‡

3. æ–­çº¿é‡è¿ï¼š
   â”œâ”€â”€ æŒ‡æ•°é€€é¿ï¼ˆ1s, 2s, 4s, 8s...ï¼‰
   â”œâ”€â”€ ä¿å­˜ç¼–ç å™¨çŠ¶æ€
   â””â”€â”€ é‡è¿åå‘é€ I å¸§

å®ç°ç¤ºä¾‹ï¼š
class RTMPPublisher {
  async publish() {
    while (true) {
      try {
        await this.connect();
        await this.sendStream();
      } catch (err) {
        console.log('æ¨æµå¤±è´¥ï¼Œé‡è¿ä¸­...');
        await this.exponentialBackoff();
      }
    }
  }
  
  async exponentialBackoff() {
    const delay = Math.min(1000 * Math.pow(2, this.retryCount), 30000);
    await sleep(delay);
    this.retryCount++;
  }
  
  async sendStream() {
    const sendBuffer = this.socket.bufferSize;
    if (sendBuffer > this.maxBuffer * 0.5) {
      // ç¼“å†²åŒºå †ç§¯ï¼Œé™ä½ç ç‡
      this.encoder.setBitrate(this.currentBitrate * 0.8);
    }
  }
}
```

---

### æœåŠ¡å™¨ç«¯ï¼šæµå¤„ç†ä¸­æ¢

#### 1. æ¥æ”¶æ¨æµ

**RTMP æœåŠ¡å™¨æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RTMP æœåŠ¡å™¨                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  [è¿æ¥ç®¡ç†å™¨]                         â”‚
â”‚  â”œâ”€â”€ ç›‘å¬ TCP 1935                   â”‚
â”‚  â”œâ”€â”€ æ¥å—è¿æ¥                         â”‚
â”‚  â””â”€â”€ RTMP æ¡æ‰‹                       â”‚
â”‚       â†“                              â”‚
â”‚  [åè®®è§£æå™¨]                         â”‚
â”‚  â”œâ”€â”€ æ¥æ”¶ TCP æ•°æ®                   â”‚
â”‚  â”œâ”€â”€ è§£æ RTMP Chunk                 â”‚
â”‚  â”œâ”€â”€ é‡ç»„ Message                    â”‚
â”‚  â””â”€â”€ è§£æå‘½ä»¤ï¼ˆconnect/publishï¼‰     â”‚
â”‚       â†“                              â”‚
â”‚  [æµç®¡ç†å™¨]                           â”‚
â”‚  â”œâ”€â”€ åˆ›å»º Stream å¯¹è±¡                â”‚
â”‚  â”œâ”€â”€ å­˜å‚¨æµä¿¡æ¯                       â”‚
â”‚  â”‚   â”œâ”€â”€ streamKey                   â”‚
â”‚  â”‚   â”œâ”€â”€ ç¼–ç å‚æ•°                     â”‚
â”‚  â”‚   â””â”€â”€ è§‚ä¼—åˆ—è¡¨                     â”‚
â”‚  â””â”€â”€ GOP ç¼“å­˜                        â”‚
â”‚       â†“                              â”‚
â”‚  [æ•°æ®åˆ†å‘]                           â”‚
â”‚  â”œâ”€â”€ è½¬å‘ç»™æ‹‰æµå®¢æˆ·ç«¯                 â”‚
â”‚  â”œâ”€â”€ æ¨é€åˆ° CDN                      â”‚
â”‚  â””â”€â”€ å†™å…¥å½•åˆ¶æ–‡ä»¶                     â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**GOP ç¼“å­˜æœºåˆ¶**ï¼š
```
ä¸ºä»€ä¹ˆéœ€è¦ GOP ç¼“å­˜ï¼Ÿ

åœºæ™¯ï¼šæ–°è§‚ä¼—åŠ å…¥ç›´æ’­é—´

æ—  GOP ç¼“å­˜ï¼š
â”œâ”€â”€ æ–°è§‚ä¼—è¿æ¥
â”œâ”€â”€ æ¥æ”¶ P å¸§ï¼ˆæ— æ³•è§£ç ï¼Œéœ€è¦ I å¸§ï¼‰
â”œâ”€â”€ ç­‰å¾…ä¸‹ä¸€ä¸ª I å¸§ï¼ˆæœ€å¤š 2 ç§’ï¼‰
â””â”€â”€ ç”»é¢é»‘å± 2 ç§’ âŒ

æœ‰ GOP ç¼“å­˜ï¼š
â”œâ”€â”€ æœåŠ¡å™¨ç¼“å­˜æœ€è¿‘ä¸€ä¸ª GOP
â”‚   â””â”€â”€ I P P P P P ...ï¼ˆ15-60 å¸§ï¼‰
â”œâ”€â”€ æ–°è§‚ä¼—è¿æ¥
â”œâ”€â”€ ç«‹å³å‘é€ç¼“å­˜çš„ GOP
â””â”€â”€ ç”»é¢å¿«é€Ÿæ˜¾ç¤º âœ…

å®ç°ï¼š
class StreamGOPCache {
  constructor() {
    this.cache = [];
    this.maxSize = 60;  // æœ€å¤šç¼“å­˜ 60 å¸§
  }
  
  onVideoFrame(frame) {
    if (frame.isKeyframe) {
      // æ”¶åˆ°æ–°çš„ I å¸§ï¼Œæ¸…ç©ºæ—§ç¼“å­˜
      this.cache = [];
    }
    
    this.cache.push(frame);
    
    // é™åˆ¶ç¼“å­˜å¤§å°
    if (this.cache.length > this.maxSize) {
      this.cache.shift();
    }
  }
  
  getGOP() {
    return this.cache;
  }
}

// æ–°è§‚ä¼—åŠ å…¥
onNewViewer(viewer) {
  // å‘é€ GOP ç¼“å­˜
  const gop = this.stream.gopCache.getGOP();
  for (const frame of gop) {
    viewer.send(frame);
  }
  
  // ç»§ç»­å‘é€å®æ—¶æµ
  this.stream.on('frame', (frame) => {
    viewer.send(frame);
  });
}
```

---

#### 2. è½¬ç ï¼ˆå¯é€‰ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦è½¬ç ï¼Ÿ**
```
åœºæ™¯1ï¼šå¤šç ç‡è‡ªé€‚åº”
â”œâ”€â”€ ä¸»æ’­æ¨æµï¼š1080p @ 6Mbps
â”œâ”€â”€ è§‚ä¼—1ï¼ˆå…‰çº¤ï¼‰ï¼š1080p @ 6Mbps
â”œâ”€â”€ è§‚ä¼—2ï¼ˆ4Gï¼‰ï¼š720p @ 2Mbps
â””â”€â”€ è§‚ä¼—3ï¼ˆ3Gï¼‰ï¼š480p @ 800Kbps

åœºæ™¯2ï¼šå…¼å®¹æ€§
â”œâ”€â”€ ä¸»æ’­æ¨æµï¼šH.265 (HEVC)
â””â”€â”€ è½¬ç  â†’ H.264ï¼ˆæ›´å¥½çš„å…¼å®¹æ€§ï¼‰

åœºæ™¯3ï¼šç‰¹æ®Šå¤„ç†
â”œâ”€â”€ æ·»åŠ æ°´å°
â”œâ”€â”€ ç”»ä¸­ç”»ï¼ˆå¤šä¸»æ’­ï¼‰
â””â”€â”€ å®æ—¶å­—å¹•
```

**è½¬ç æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æºæµ (1080p @ 6Mbps)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            è½¬ç æœåŠ¡å™¨é›†ç¾¤               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Worker 1:                             â”‚
â”‚  â”œâ”€â”€ è§£ç  H.264 â†’ YUV                  â”‚
â”‚  â”œâ”€â”€ ä¿æŒ 1920Ã—1080                    â”‚
â”‚  â”œâ”€â”€ ç¼–ç  â†’ H.264 @ 6Mbps              â”‚
â”‚  â””â”€â”€ è¾“å‡ºï¼š1080p.flv                   â”‚
â”‚                                        â”‚
â”‚  Worker 2:                             â”‚
â”‚  â”œâ”€â”€ è§£ç  H.264 â†’ YUV                  â”‚
â”‚  â”œâ”€â”€ ç¼©æ”¾ â†’ 1280Ã—720                   â”‚
â”‚  â”œâ”€â”€ ç¼–ç  â†’ H.264 @ 2Mbps              â”‚
â”‚  â””â”€â”€ è¾“å‡ºï¼š720p.flv                    â”‚
â”‚                                        â”‚
â”‚  Worker 3:                             â”‚
â”‚  â”œâ”€â”€ è§£ç  H.264 â†’ YUV                  â”‚
â”‚  â”œâ”€â”€ ç¼©æ”¾ â†’ 854Ã—480                    â”‚
â”‚  â”œâ”€â”€ ç¼–ç  â†’ H.264 @ 800Kbps            â”‚
â”‚  â””â”€â”€ è¾“å‡ºï¼š480p.flv                    â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æˆæœ¬è®¡ç®—ï¼š
â”œâ”€â”€ è§£ç ï¼š0.5 æ ¸CPUï¼ˆç¡¬ä»¶è§£ç ï¼‰
â”œâ”€â”€ ç¼©æ”¾ï¼š0.1 æ ¸CPU
â”œâ”€â”€ ç¼–ç ï¼š2 æ ¸CPUï¼ˆè½¯ä»¶ï¼‰æˆ– 0.3æ ¸ï¼ˆç¡¬ä»¶ï¼‰
â””â”€â”€ æ€»è®¡ï¼š3ä¸ªç ç‡ = 7.8 æ ¸CPUï¼ˆè½¯ä»¶ï¼‰
```

**è½¬ç æ€§èƒ½ä¼˜åŒ–**ï¼š
```
1. ç¡¬ä»¶åŠ é€Ÿï¼š
   â”œâ”€â”€ NVIDIA GPU (NVENC/NVDEC)
   â”œâ”€â”€ Intel QSV
   â””â”€â”€ æˆæœ¬é™ä½ 80%

2. åˆ†å¸ƒå¼è½¬ç ï¼š
   â”œâ”€â”€ æºæµ â†’ è½¬ç è°ƒåº¦å™¨
   â”œâ”€â”€ è°ƒåº¦å™¨ â†’ å¤šä¸ªè½¬ç  Worker
   â””â”€â”€ è´Ÿè½½å‡è¡¡

3. åªè½¬ç æ´»è·ƒæµï¼š
   â”œâ”€â”€ æ— è§‚ä¼—çš„æµä¸è½¬ç 
   â””â”€â”€ å»¶è¿Ÿè½¬ç ï¼ˆè§‚ä¼—è¿›å…¥æ‰å¼€å§‹ï¼‰

4. ç¼“å­˜å¤ç”¨ï¼š
   â”œâ”€â”€ ç›¸åŒæºæµåªè§£ç ä¸€æ¬¡
   â””â”€â”€ ä¸åŒç ç‡å…±äº« YUV æ•°æ®
```

---

#### 3. åè®®è½¬æ¢

**RTMP â†’ HTTP-FLV**ï¼š
```
è¿™æ˜¯æœ€ç®€å•çš„è½¬æ¢ï¼ˆå‡ ä¹é›¶å¼€é”€ï¼‰

RTMP Chunk â†’ FLV Tag è½¬æ¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RTMP Message           â”‚
â”‚  â”œâ”€â”€ Message Type (9)   â”‚ â”€â”€â”€â†’ FLV Tag Type (9)
â”‚  â”œâ”€â”€ Timestamp          â”‚ â”€â”€â”€â†’ FLV Timestamp
â”‚  â”œâ”€â”€ Message Length     â”‚ â”€â”€â”€â†’ FLV Data Size
â”‚  â””â”€â”€ Payload            â”‚ â”€â”€â”€â†’ FLV Tag Data
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä»£ç ç¤ºä¾‹ï¼ˆNode.jsï¼‰ï¼š
class FlvConverter {
  rtmpToFlv(rtmpMessage) {
    const flvTag = Buffer.alloc(11 + rtmpMessage.length);
    
    // Tag Type
    flvTag.writeUInt8(rtmpMessage.type, 0);
    
    // Data Size (3 bytes, big-endian)
    flvTag.writeUIntBE(rtmpMessage.length, 1, 3);
    
    // Timestamp (3 bytes)
    flvTag.writeUIntBE(rtmpMessage.timestamp & 0xFFFFFF, 4, 3);
    
    // Timestamp Extended (1 byte)
    flvTag.writeUInt8((rtmpMessage.timestamp >> 24) & 0xFF, 7);
    
    // Stream ID (always 0)
    flvTag.writeUIntBE(0, 8, 3);
    
    // Tag Data
    rtmpMessage.payload.copy(flvTag, 11);
    
    return flvTag;
  }
}

// HTTP-FLV æœåŠ¡å™¨
app.get('/live/:stream.flv', (req, res) => {
  const stream = req.params.stream;
  
  // è®¾ç½® HTTP å“åº”å¤´
  res.writeHead(200, {
    'Content-Type': 'video/x-flv',
    'Transfer-Encoding': 'chunked',
    'Connection': 'keep-alive',
    'Access-Control-Allow-Origin': '*',
    'Cache-Control': 'no-cache'
  });
  
  // å†™å…¥ FLV Header
  const flvHeader = createFlvHeader();
  res.write(flvHeader);
  
  // ç›‘å¬ RTMP æµ
  const rtmpStream = rtmpServer.getStream(stream);
  
  // å‘é€ GOP ç¼“å­˜
  const gop = rtmpStream.gopCache.getGOP();
  for (const msg of gop) {
    const flvTag = rtmpToFlv(msg);
    res.write(flvTag);
    res.write(Buffer.alloc(4).writeUInt32BE(flvTag.length));
  }
  
  // å®æ—¶è½¬å‘
  rtmpStream.on('data', (msg) => {
    const flvTag = rtmpToFlv(msg);
    res.write(flvTag);
    res.write(Buffer.alloc(4).writeUInt32BE(flvTag.length));
  });
  
  // å®¢æˆ·ç«¯æ–­å¼€
  req.on('close', () => {
    rtmpStream.removeListener('data');
  });
});
```

**RTMP â†’ HLS**ï¼š
```
è¿™éœ€è¦å®æ—¶åˆ‡ç‰‡ï¼ˆå¼€é”€è¾ƒå¤§ï¼‰

æµç¨‹ï¼š
RTMP æµ
    â†“
è§£å°è£…ï¼ˆFLV â†’ H.264 + AACï¼‰
    â†“
ç¼“å†²ï¼ˆç´¯ç§¯åˆ°åˆ‡ç‰‡æ—¶é•¿ï¼‰
    â†“
TS å°è£…
â”œâ”€â”€ PAT (Program Association Table)
â”œâ”€â”€ PMT (Program Map Table)
â””â”€â”€ PES (Packetized Elementary Stream)
    â†“
å†™å…¥ TS æ–‡ä»¶ï¼ˆsegment_N.tsï¼‰
    â†“
æ›´æ–° m3u8 ç´¢å¼•

å®ç°å…³é”®ç‚¹ï¼š
1. æ£€æµ‹å…³é”®å¸§ï¼š
   åªåœ¨å…³é”®å¸§å¤„åˆ‡ç‰‡ï¼ˆé¿å…æ’­æ”¾å™¨æ— æ³•è§£ç ï¼‰

2. æ—¶é•¿æ§åˆ¶ï¼š
   ç›®æ ‡åˆ‡ç‰‡æ—¶é•¿ï¼š6ç§’
   å®é™…åˆ‡ç‰‡æ—¶é•¿ï¼š5.5-6.5ç§’ï¼ˆå–å†³äºGOPï¼‰

3. æ»‘åŠ¨çª—å£ï¼š
   ä¿ç•™æœ€æ–° N ä¸ªåˆ‡ç‰‡ï¼ˆå¦‚ 10 ä¸ªï¼‰
   åˆ é™¤æ—§åˆ‡ç‰‡

ä»£ç ç¤ºä¾‹ï¼š
class HLSSegmenter {
  constructor(targetDuration = 6) {
    this.targetDuration = targetDuration;
    this.currentSegment = [];
    this.currentDuration = 0;
    this.segmentIndex = 0;
  }
  
  onFrame(frame) {
    this.currentSegment.push(frame);
    this.currentDuration += frame.duration;
    
    // è¾¾åˆ°ç›®æ ‡æ—¶é•¿ && é‡åˆ°å…³é”®å¸§
    if (this.currentDuration >= this.targetDuration && frame.isKeyframe) {
      this.flushSegment();
    }
  }
  
  flushSegment() {
    const filename = `segment_${this.segmentIndex}.ts`;
    
    // å°è£…æˆ TS
    const tsData = this.muxToTS(this.currentSegment);
    fs.writeFileSync(filename, tsData);
    
    // æ›´æ–° m3u8
    this.updatePlaylist(filename, this.currentDuration);
    
    // é‡ç½®
    this.currentSegment = [];
    this.currentDuration = 0;
    this.segmentIndex++;
  }
  
  updatePlaylist(filename, duration) {
    const playlist = `#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:${Math.ceil(this.targetDuration)}
#EXT-X-MEDIA-SEQUENCE:${Math.max(0, this.segmentIndex - 10)}

${this.getLastNSegments(10).map(seg => 
  `#EXTINF:${seg.duration.toFixed(3)},\n${seg.filename}`
).join('\n')}
`;
    fs.writeFileSync('index.m3u8', playlist);
  }
}
```

---

#### 4. CDN åˆ†å‘

**CDN æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æºç«™                        â”‚
â”‚  â”œâ”€â”€ æ¥æ”¶ä¸»æ’­æ¨æµ                         â”‚
â”‚  â”œâ”€â”€ è½¬ç ï¼ˆå¤šç ç‡ï¼‰                       â”‚
â”‚  â””â”€â”€ æ¨é€åˆ° CDN                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          CDN è¾¹ç¼˜èŠ‚ç‚¹ï¼ˆå…¨çƒï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  åŒ—äº¬èŠ‚ç‚¹ï¼š                               â”‚
â”‚  â”œâ”€â”€ ç¼“å­˜çƒ­é—¨æµ                           â”‚
â”‚  â””â”€â”€ æœåŠ¡åŒ—æ–¹è§‚ä¼—                         â”‚
â”‚                                          â”‚
â”‚  ä¸Šæµ·èŠ‚ç‚¹ï¼š                               â”‚
â”‚  â”œâ”€â”€ ç¼“å­˜çƒ­é—¨æµ                           â”‚
â”‚  â””â”€â”€ æœåŠ¡åä¸œè§‚ä¼—                         â”‚
â”‚                                          â”‚
â”‚  æ·±åœ³èŠ‚ç‚¹ï¼š                               â”‚
â”‚  â””â”€â”€ ...                                 â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CDN è°ƒåº¦ï¼š
è§‚ä¼—è¯·æ±‚ â†’ DNS è§£æ â†’ å°±è¿‘èŠ‚ç‚¹
â”œâ”€â”€ å›½å†…è§‚ä¼— â†’ å›½å†…èŠ‚ç‚¹
â””â”€â”€ å›½é™…è§‚ä¼— â†’ å›½é™…èŠ‚ç‚¹
```

**HTTP-FLV çš„ CDN æŒ‘æˆ˜**ï¼š
```
é—®é¢˜ï¼š
â”œâ”€â”€ é•¿è¿æ¥ï¼ˆæ— æ³•åˆ©ç”¨æ ‡å‡† HTTP ç¼“å­˜ï¼‰
â”œâ”€â”€ æ¯ä¸ªè§‚ä¼—ä¸€æ¡ç‹¬ç«‹è¿æ¥
â””â”€â”€ CDN å›æºå‹åŠ›å¤§

è§£å†³æ–¹æ¡ˆï¼š

1. è¾¹ç¼˜ç¼“å­˜ï¼š
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CDN èŠ‚ç‚¹ â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â†’ è§‚ä¼—1 â”€â”
        â”œâ”€â†’ è§‚ä¼—2  â”œâ”€ å…±äº«ä¸€æ¡å›æºè¿æ¥
        â””â”€â†’ è§‚ä¼—3 â”€â”˜
   
   å®ç°ï¼š
   - CDN èŠ‚ç‚¹ç»´æŠ¤ä¸€æ¡åˆ°æºç«™çš„è¿æ¥
   - å¤šä¸ªè§‚ä¼—å…±äº«è¿™æ¡è¿æ¥çš„æ•°æ®
   - å‡å°‘å›æºå¸¦å®½

2. GOP å¯¹é½ï¼š
   ç¡®ä¿ CDN ä» I å¸§å¼€å§‹æ‹‰æµ
   é¿å…èŠ±å±

3. æ™ºèƒ½å›æºï¼š
   if (è§‚ä¼—æ•° > 0) {
     ä¿æŒå›æºè¿æ¥
   } else {
     30ç§’åæ–­å¼€ï¼ˆèŠ‚çœæˆæœ¬ï¼‰
   }
```

**HLS çš„ CDN ä¼˜åŠ¿**ï¼š
```
å®Œç¾é€‚é… CDNï¼š

1. æ ‡å‡† HTTP è¯·æ±‚ï¼š
   GET /live/segment_100.ts
   
2. æ–‡ä»¶å¯ç¼“å­˜ï¼š
   Cache-Control: max-age=6
   
3. é«˜ç¼“å­˜å‘½ä¸­ç‡ï¼š
   â”œâ”€â”€ åŒä¸€ä¸ªåˆ‡ç‰‡è¢«å¤šä¸ªè§‚ä¼—è¯·æ±‚
   â”œâ”€â”€ CDN ç¼“å­˜è¯¥åˆ‡ç‰‡
   â””â”€â”€ å‡å°‘å›æº

4. åˆ†çº§ç¼“å­˜ï¼š
   è§‚ä¼— â†’ L1 CDN â†’ L2 CDN â†’ æºç«™
   â””â”€â”€ ç¦»è§‚ä¼—æœ€è¿‘çš„èŠ‚ç‚¹

æˆæœ¬å¯¹æ¯”ï¼ˆ10ä¸‡å¹¶å‘ï¼‰ï¼š
HTTP-FLVï¼š
â”œâ”€â”€ å›æºå¸¦å®½ï¼š600Mbps
â””â”€â”€ æˆæœ¬ï¼š$900/æœˆ

HLSï¼š
â”œâ”€â”€ å›æºå¸¦å®½ï¼š100Mbpsï¼ˆç¼“å­˜å‘½ä¸­ç‡ 85%ï¼‰
â””â”€â”€ æˆæœ¬ï¼š$150/æœˆ
```

---

### è§‚ä¼—ç«¯ï¼šæ’­æ”¾ä¸æ¸²æŸ“

#### 1. ä¸‹è½½æ•°æ®

**HTTP-FLV æ’­æ”¾å™¨æµç¨‹**ï¼š
```javascript
class FlvPlayer {
  async play(url) {
    // 1. å‘èµ· HTTP è¯·æ±‚
    const response = await fetch(url);
    const reader = response.body.getReader();
    
    // 2. åˆ›å»º MediaSource
    this.mediaSource = new MediaSource();
    this.video.src = URL.createObjectURL(this.mediaSource);
    
    await new Promise(resolve => {
      this.mediaSource.addEventListener('sourceopen', resolve);
    });
    
    // 3. åˆ›å»º SourceBuffer
    this.sourceBuffer = this.mediaSource.addSourceBuffer(
      'video/mp4; codecs="avc1.64001f,mp4a.40.2"'
    );
    
    // 4. è¯»å– FLV æ•°æ®
    this.readLoop(reader);
  }
  
  async readLoop(reader) {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      // 5. è§£æ FLV
      const flvTags = this.flvDemuxer.parse(value);
      
      // 6. è½¬æ¢æˆ fMP4
      const mp4Boxes = this.remuxer.remux(flvTags);
      
      // 7. å–‚ç»™ SourceBuffer
      await this.appendBuffer(mp4Boxes);
    }
  }
  
  async appendBuffer(data) {
    return new Promise((resolve, reject) => {
      if (this.sourceBuffer.updating) {
        // ç­‰å¾…ä¸Šä¸€æ¬¡æ“ä½œå®Œæˆ
        this.sourceBuffer.addEventListener('updateend', () => {
          this.sourceBuffer.appendBuffer(data);
          resolve();
        }, { once: true });
      } else {
        this.sourceBuffer.appendBuffer(data);
        this.sourceBuffer.addEventListener('updateend', resolve, { once: true });
      }
    });
  }
}
```

**HLS æ’­æ”¾å™¨æµç¨‹**ï¼š
```javascript
class HlsPlayer {
  async play(url) {
    // 1. ä¸‹è½½ m3u8
    const playlist = await this.fetchPlaylist(url);
    
    // 2. è§£æ m3u8
    const segments = this.parsePlaylist(playlist);
    
    // 3. åˆ›å»º MediaSource
    this.mediaSource = new MediaSource();
    this.video.src = URL.createObjectURL(this.mediaSource);
    
    await new Promise(resolve => {
      this.mediaSource.addEventListener('sourceopen', resolve);
    });
    
    // 4. åˆ›å»º SourceBuffer
    this.sourceBuffer = this.mediaSource.addSourceBuffer(
      'video/mp4; codecs="avc1.64001f,mp4a.40.2"'
    );
    
    // 5. ä¸‹è½½å¹¶æ’­æ”¾åˆ‡ç‰‡
    this.playSegments(segments);
    
    // 6. å®šæœŸåˆ·æ–°æ’­æ”¾åˆ—è¡¨
    this.refreshPlaylist(url);
  }
  
  async playSegments(segments) {
    for (const seg of segments) {
      // ä¸‹è½½ TS åˆ‡ç‰‡
      const tsData = await fetch(seg.url).then(r => r.arrayBuffer());
      
      // TS â†’ MP4 è½¬æ¢
      const mp4Boxes = this.tsDemuxer.demux(tsData);
      
      // å–‚ç»™ SourceBuffer
      await this.appendBuffer(mp4Boxes);
    }
  }
  
  async refreshPlaylist(url) {
    setInterval(async () => {
      const playlist = await this.fetchPlaylist(url);
      const newSegments = this.parsePlaylist(playlist);
      
      // æ‰¾å‡ºæ–°å¢çš„åˆ‡ç‰‡
      const toDownload = newSegments.filter(seg => 
        !this.downloadedSegments.has(seg.url)
      );
      
      // ä¸‹è½½æ–°åˆ‡ç‰‡
      this.playSegments(toDownload);
    }, 3000);  // æ¯ 3 ç§’åˆ·æ–°
  }
}
```

---

#### 2. è§£å°è£…ä¸è§£ç 

**æµè§ˆå™¨å†…éƒ¨æµç¨‹**ï¼š
```
SourceBuffer.appendBuffer(mp4Data)
    â†“
æµè§ˆå™¨åª’ä½“å¼•æ“ï¼ˆå¦‚ Chromium Mediaï¼‰
    â†“
è§£å°è£…å™¨ (Demuxer)
â”œâ”€â”€ è§£æ MP4 Container
â”œâ”€â”€ æå–è§†é¢‘è½¨é“ï¼ˆH.264ï¼‰
â””â”€â”€ æå–éŸ³é¢‘è½¨é“ï¼ˆAACï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§†é¢‘è§£ç å™¨      â”‚    éŸ³é¢‘è§£ç å™¨     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ H.264 Decoder    â”‚ AAC Decoder      â”‚
â”‚ (ç¡¬ä»¶åŠ é€Ÿ)       â”‚                  â”‚
â”‚ â”œâ”€â”€ SPS/PPSè§£æ  â”‚ â”œâ”€â”€ ADTSè§£æ     â”‚
â”‚ â”œâ”€â”€ NALUè§£ç      â”‚ â”œâ”€â”€ MDCTé€†å˜æ¢   â”‚
â”‚ â””â”€â”€ YUVè¾“å‡º      â”‚ â””â”€â”€ PCMè¾“å‡º      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                    â†“
    Video Renderer      Audio Renderer
    (GPUæ¸²æŸ“)           (éŸ³é¢‘è®¾å¤‡)
```

**ç¡¬ä»¶è§£ç  vs è½¯ä»¶è§£ç **ï¼š
```
ç¡¬ä»¶è§£ç ï¼ˆVideoToolbox/DXVA/VAAPIï¼‰ï¼š
ä¼˜ç‚¹ï¼š
âœ… åŠŸè€—ä½ï¼ˆ5W vs 30Wï¼‰
âœ… é€Ÿåº¦å¿«ï¼ˆå®æ—¶4K@60fpsï¼‰
âœ… CPU å ç”¨ä½ï¼ˆ5% vs 80%ï¼‰

ç¼ºç‚¹ï¼š
âŒ åŠŸèƒ½å—é™ï¼ˆä¸æ”¯æŒæ‰€æœ‰ Profileï¼‰
âŒ å…¼å®¹æ€§é—®é¢˜ï¼ˆé©±åŠ¨ Bugï¼‰

è½¯ä»¶è§£ç ï¼ˆFFmpeg libavcodecï¼‰ï¼š
ä¼˜ç‚¹ï¼š
âœ… åŠŸèƒ½å®Œæ•´
âœ… å…¼å®¹æ€§å¥½
âœ… å¯è‡ªå®šä¹‰

ç¼ºç‚¹ï¼š
âŒ CPU å ç”¨é«˜
âŒ åŠŸè€—é«˜
âŒ ç§»åŠ¨ç«¯å‘çƒ­

æµè§ˆå™¨ç­–ç•¥ï¼š
â”œâ”€â”€ ä¼˜å…ˆå°è¯•ç¡¬ä»¶è§£ç 
â”œâ”€â”€ å¤±è´¥åˆ™é™çº§åˆ°è½¯ä»¶è§£ç 
â””â”€â”€ è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ
```

---

#### 3. éŸ³è§†é¢‘åŒæ­¥

**PTS/DTS åŒæ­¥æœºåˆ¶**ï¼š
```
é—®é¢˜ï¼šéŸ³è§†é¢‘åˆ†åˆ«è§£ç ï¼Œå¦‚ä½•åŒæ­¥æ’­æ”¾ï¼Ÿ

æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´æˆ³

è§†é¢‘æµï¼š
Frame 1: PTS = 0ms
Frame 2: PTS = 33ms
Frame 3: PTS = 66ms
...

éŸ³é¢‘æµï¼š
Frame 1: PTS = 0ms
Frame 2: PTS = 21ms  (1024 samples / 48000 Hz * 1000)
Frame 3: PTS = 43ms
...

æ’­æ”¾å™¨åŒæ­¥ç®—æ³•ï¼š
1. é€‰æ‹©å‚è€ƒæ—¶é’Ÿï¼ˆé€šå¸¸æ˜¯éŸ³é¢‘ï¼Œå› ä¸ºäººè€³æ•æ„Ÿï¼‰
2. è®¡ç®—è§†é¢‘å¸§çš„æ’­æ”¾æ—¶åˆ»ï¼š
   videoTime = videoPTS - videoPTS0
3. å¯¹æ¯”å½“å‰æ’­æ”¾æ—¶åˆ»ï¼š
   currentTime = audioClock
4. å†³ç­–ï¼š
   if (videoTime < currentTime - 100ms) {
     // è§†é¢‘å¤ªæ…¢ï¼Œä¸¢å¸§è¿½èµ¶
     skipFrame();
   } else if (videoTime > currentTime + 100ms) {
     // è§†é¢‘å¤ªå¿«ï¼Œç­‰å¾…éŸ³é¢‘
     wait(videoTime - currentTime);
   } else {
     // æ­£å¸¸æ’­æ”¾
     renderFrame();
   }
```

**Web Audio API ç²¾ç¡®åŒæ­¥**ï¼š
```javascript
class AVSync {
  constructor(video, audioContext) {
    this.video = video;
    this.audioContext = audioContext;
    this.baseTime = 0;
  }
  
  syncVideo() {
    // è·å–éŸ³é¢‘æ’­æ”¾æ—¶é—´ï¼ˆé«˜ç²¾åº¦ï¼‰
    const audioTime = this.audioContext.currentTime - this.baseTime;
    
    // è·å–è§†é¢‘æ’­æ”¾æ—¶é—´
    const videoTime = this.video.currentTime;
    
    // è®¡ç®—åå·®
    const drift = videoTime - audioTime;
    
    if (Math.abs(drift) > 0.1) {
      // åå·®è¶…è¿‡ 100msï¼Œæ ¡æ­£
      console.log(`éŸ³è§†é¢‘åå·®: ${drift}msï¼Œæ ¡æ­£ä¸­...`);
      this.video.currentTime = audioTime;
    }
    
    // å®šæœŸæ£€æŸ¥ï¼ˆæ¯ç§’ï¼‰
    setTimeout(() => this.syncVideo(), 1000);
  }
}
```

---

#### 4. æ¸²æŸ“

**è§†é¢‘æ¸²æŸ“ç®¡çº¿**ï¼š
```
YUV å¸§æ•°æ®ï¼ˆè§£ç å™¨è¾“å‡ºï¼‰
    â†“
GPU ä¸Šä¼ ï¼ˆCPU â†’ GPU å†…å­˜ï¼‰
    â†“
YUV â†’ RGB è½¬æ¢ï¼ˆShaderï¼‰
    â†“
è‰²å½©ç©ºé—´è½¬æ¢ï¼ˆBT.709 / BT.2020ï¼‰
    â†“
ä¼½é©¬æ ¡æ­£
    â†“
åˆæˆï¼ˆè§†é¢‘ + UI å±‚ï¼‰
    â†“
æ˜¾ç¤ºåˆ°å±å¹•

æ€§èƒ½ä¼˜åŒ–ï¼š
1. é›¶æ‹·è´ï¼ˆZero-copyï¼‰ï¼š
   è§£ç å™¨ç›´æ¥è¾“å‡ºåˆ° GPU çº¹ç†
   é¿å… CPU <-> GPU æ•°æ®ä¼ è¾“

2. ç¡¬ä»¶è¦†ç›–å±‚ï¼ˆHardware Overlayï¼‰ï¼š
   è§†é¢‘ç›´æ¥æ¸²æŸ“åˆ°ç‹¬ç«‹å›¾å±‚
   é¿å…ä¸UIåˆæˆ

3. å‚ç›´åŒæ­¥ï¼ˆVSyncï¼‰ï¼š
   ä¸å±å¹•åˆ·æ–°ç‡åŒæ­¥ï¼ˆ60Hzï¼‰
   é¿å…ç”»é¢æ’•è£‚
```

---

## å»¶è¿Ÿä¼˜åŒ–å®æˆ˜

### å»¶è¿Ÿåˆ†æå·¥å…·

**æµ‹é‡ç«¯åˆ°ç«¯å»¶è¿Ÿ**ï¼š
```javascript
// ä¸»æ’­ç«¯ï¼šåœ¨è§†é¢‘å¸§ä¸Šå åŠ æ—¶é—´æˆ³
function addTimestamp(frame) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = frame.width;
  canvas.height = frame.height;
  
  // ç»˜åˆ¶è§†é¢‘å¸§
  ctx.drawImage(frame, 0, 0);
  
  // å åŠ æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
  const timestamp = Date.now();
  ctx.fillStyle = 'yellow';
  ctx.font = '48px monospace';
  ctx.fillText(timestamp.toString(), 50, 50);
  
  return canvas;
}

// è§‚ä¼—ç«¯ï¼šOCR è¯†åˆ«æ—¶é—´æˆ³
function measureLatency(video) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  setInterval(() => {
    // æˆªå–è§†é¢‘å¸§
    ctx.drawImage(video, 0, 0);
    
    // OCR è¯†åˆ«æ—¶é—´æˆ³ï¼ˆç®€åŒ–ï¼‰
    const imageData = ctx.getImageData(50, 50, 500, 60);
    const streamTimestamp = ocr(imageData);
    
    // è®¡ç®—å»¶è¿Ÿ
    const currentTimestamp = Date.now();
    const latency = currentTimestamp - streamTimestamp;
    
    console.log(`ç«¯åˆ°ç«¯å»¶è¿Ÿ: ${latency}ms`);
  }, 1000);
}
```

**åˆ†æ®µå»¶è¿Ÿæµ‹é‡**ï¼š
```javascript
const metrics = {
  capture: 0,    // é‡‡é›†å»¶è¿Ÿ
  encode: 0,     // ç¼–ç å»¶è¿Ÿ
  push: 0,       // æ¨æµå»¶è¿Ÿ
  server: 0,     // æœåŠ¡å™¨å¤„ç†
  network: 0,    // ç½‘ç»œä¼ è¾“
  pull: 0,       // æ‹‰æµå»¶è¿Ÿ
  decode: 0,     // è§£ç å»¶è¿Ÿ
  render: 0      // æ¸²æŸ“å»¶è¿Ÿ
};

// ä¸»æ’­ç«¯æµ‹é‡
const t1 = performance.now();
const frame = captureFrame();
const t2 = performance.now();
metrics.capture = t2 - t1;

const encoded = await encoder.encode(frame);
const t3 = performance.now();
metrics.encode = t3 - t2;

await rtmpClient.send(encoded);
const t4 = performance.now();
metrics.push = t4 - t3;

// é€šè¿‡ä¿¡ä»¤é€šé“å‘é€åˆ°è§‚ä¼—ç«¯
sendMetrics(metrics);
```

### ä¼˜åŒ–ç­–ç•¥ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

#### 1. å‡å° GOPï¼ˆç«‹ç«¿è§å½±ï¼‰
```bash
# ä¼˜åŒ–å‰ï¼šGOP=60ï¼ˆ2ç§’ï¼‰
ffmpeg ... -g 60 -keyint_min 60 ...

# ä¼˜åŒ–åï¼šGOP=30ï¼ˆ1ç§’ï¼‰
ffmpeg ... -g 30 -keyint_min 30 ...

æ•ˆæœï¼š
â”œâ”€â”€ æ–°è§‚ä¼—è¿›å…¥å»¶è¿Ÿï¼š2ç§’ â†’ 1ç§’
â”œâ”€â”€ èŠ±å±æ¢å¤æ—¶é—´ï¼š2ç§’ â†’ 1ç§’
â””â”€â”€ ç ç‡å¢åŠ ï¼š~5-10%ï¼ˆIå¸§æ›´é¢‘ç¹ï¼‰

æƒè¡¡ï¼š
âœ… å»¶è¿Ÿæ˜¾è‘—é™ä½
âŒ ç ç‡ç•¥å¾®å¢åŠ 
```

#### 2. å¯ç”¨ä½å»¶è¿Ÿç¼–ç 
```bash
# x264 ä½å»¶è¿Ÿå‚æ•°
ffmpeg ... \
  -tune zerolatency \     # é›¶å»¶è¿Ÿä¼˜åŒ–
  -preset ultrafast \     # æœ€å¿«ç¼–ç 
  -profile:v baseline \   # åŸºç¡€profileï¼ˆæ— Bå¸§ï¼‰
  -bf 0 \                 # ç¦ç”¨Bå¸§
  -refs 1 \               # åªå‚è€ƒ1ä¸ªå‚è€ƒå¸§
  -sc_threshold 0 \       # ç¦ç”¨åœºæ™¯åˆ‡æ¢æ£€æµ‹
  ...

æ•ˆæœï¼š
â”œâ”€â”€ ç¼–ç å»¶è¿Ÿï¼š50ms â†’ 20ms
â””â”€â”€ ç”»è´¨ï¼šç•¥å¾®ä¸‹é™ï¼ˆå¯æ¥å—ï¼‰
```

#### 3. å‡å°‘æ’­æ”¾å™¨ç¼“å†²
```javascript
// flv.js é…ç½®
{
  enableStashBuffer: false,    // ç¦ç”¨é¢å¤–ç¼“å†²
  stashInitialSize: 128,       // æœ€å°åˆå§‹ç¼“å†²ï¼ˆKBï¼‰
  isLive: true,                // ç›´æ’­æ¨¡å¼
  lazyLoad: false,             // ä¸æ‡’åŠ è½½
  lazyLoadMaxDuration: 0       // ä¸é¢„åŠ è½½
}

// hls.js é…ç½®
{
  liveSyncDurationCount: 1,    // åªç¼“å†²1ä¸ªåˆ‡ç‰‡
  liveMaxLatencyDurationCount: 3,  // æœ€å¤§3ä¸ªåˆ‡ç‰‡
  maxBufferLength: 10,         // æœ€å¤§ç¼“å†²10ç§’
  maxMaxBufferLength: 30       // æé™ç¼“å†²30ç§’
}

æ•ˆæœï¼š
â”œâ”€â”€ æ’­æ”¾å™¨å»¶è¿Ÿï¼š3ç§’ â†’ 1ç§’
â””â”€â”€ å¡é¡¿é£é™©ï¼šç•¥å¾®å¢åŠ ï¼ˆç½‘ç»œæ³¢åŠ¨æ—¶ï¼‰
```

#### 4. è‡ªåŠ¨è¿½å¸§
```javascript
// æ£€æµ‹å»¶è¿Ÿå¹¶è¿½å¸§
class LatencyCatcher {
  constructor(video) {
    this.video = video;
    this.targetLatency = 3;  // ç›®æ ‡å»¶è¿Ÿ3ç§’
    
    setInterval(() => this.check(), 1000);
  }
  
  check() {
    if (this.video.buffered.length === 0) return;
    
    // è®¡ç®—å½“å‰å»¶è¿Ÿ
    const bufferedEnd = this.video.buffered.end(0);
    const currentTime = this.video.currentTime;
    const latency = bufferedEnd - currentTime;
    
    console.log(`å½“å‰å»¶è¿Ÿ: ${latency.toFixed(2)}s`);
    
    if (latency > this.targetLatency + 2) {
      // å»¶è¿Ÿè¶…è¿‡ç›®æ ‡2ç§’ï¼Œè·³åˆ°æœ€æ–°ä½ç½®
      console.log('è¿½å¸§ä¸­...');
      this.video.currentTime = bufferedEnd - this.targetLatency;
    }
  }
}

æ•ˆæœï¼š
â”œâ”€â”€ é•¿æ—¶é—´è§‚çœ‹åçš„å»¶è¿Ÿï¼šå§‹ç»ˆä¿æŒåœ¨ç›®æ ‡å€¼
â””â”€â”€ ç”¨æˆ·ä½“éªŒï¼šå¯èƒ½ä¼šçœ‹åˆ°è·³å¸§
```

#### 5. ä½¿ç”¨ UDP æ¨æµï¼ˆSRT/WebRTCï¼‰
```bash
# SRT æ¨æµï¼ˆæ›¿ä»£ RTMPï¼‰
ffmpeg ... -f mpegts "srt://server:port?latency=1000"

# WebRTC æ¨æµï¼ˆæœ€ä½å»¶è¿Ÿï¼‰
# ä½¿ç”¨ WHIP åè®®
```

æ•ˆæœï¼š
```
             æ¨æµå»¶è¿Ÿ   æ€»å»¶è¿Ÿ
RTMP (TCP):  200ms     3-5s
SRT (UDP):   100ms     2-3s
WebRTC:      50ms      <500ms
```

---

## æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§

### æœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**ï¼š
```javascript
const metrics = {
  // è¿æ¥æŒ‡æ ‡
  activePublishers: 0,      // æ´»è·ƒæ¨æµæ•°
  activeViewers: 0,         // æ´»è·ƒè§‚ä¼—æ•°
  totalConnections: 0,      // æ€»è¿æ¥æ•°
  
  // å¸¦å®½æŒ‡æ ‡
  inboundBandwidth: 0,      // å…¥ç«™å¸¦å®½ï¼ˆMbpsï¼‰
  outboundBandwidth: 0,     // å‡ºç«™å¸¦å®½ï¼ˆMbpsï¼‰
  bandwidthUtilization: 0,  // å¸¦å®½åˆ©ç”¨ç‡ï¼ˆ%ï¼‰
  
  // æ€§èƒ½æŒ‡æ ‡
  cpuUsage: 0,              // CPU ä½¿ç”¨ç‡ï¼ˆ%ï¼‰
  memoryUsage: 0,           // å†…å­˜ä½¿ç”¨ï¼ˆMBï¼‰
  networkLatency: 0,        // ç½‘ç»œå»¶è¿Ÿï¼ˆmsï¼‰
  
  // è´¨é‡æŒ‡æ ‡
  frameDropRate: 0,         // ä¸¢å¸§ç‡ï¼ˆ%ï¼‰
  bufferUnderrun: 0,        // ç¼“å†²åŒºæ¬ è½½æ¬¡æ•°
  reconnectCount: 0         // é‡è¿æ¬¡æ•°
};

// ç›‘æ§ä»£ç 
class ServerMonitor {
  constructor() {
    setInterval(() => this.collect(), 1000);
  }
  
  collect() {
    // CPU
    const cpus = os.cpus();
    metrics.cpuUsage = this.calculateCPU(cpus);
    
    // å†…å­˜
    metrics.memoryUsage = process.memoryUsage().heapUsed / 1024 / 1024;
    
    // å¸¦å®½ï¼ˆç»Ÿè®¡æ‰€æœ‰è¿æ¥ï¼‰
    let inbound = 0, outbound = 0;
    for (const conn of this.connections) {
      inbound += conn.bytesReceived;
      outbound += conn.bytesSent;
    }
    metrics.inboundBandwidth = inbound * 8 / 1024 / 1024;  // Mbps
    metrics.outboundBandwidth = outbound * 8 / 1024 / 1024;
    
    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    this.sendToMonitoring(metrics);
  }
}
```

### å®¢æˆ·ç«¯æ€§èƒ½æŒ‡æ ‡

**æ’­æ”¾å™¨æ€§èƒ½ç›‘æ§**ï¼š
```javascript
class PlayerMonitor {
  constructor(video) {
    this.video = video;
    this.stats = {
      droppedFrames: 0,
      decodedFrames: 0,
      bufferStalls: 0,
      bitrateHistory: []
    };
    
    // ç›‘å¬äº‹ä»¶
    video.addEventListener('waiting', () => {
      this.stats.bufferStalls++;
      console.warn('ç¼“å†²æ¬ è½½ï¼ˆå¡é¡¿ï¼‰');
    });
    
    // å®šæœŸé‡‡é›†
    setInterval(() => this.collect(), 1000);
  }
  
  collect() {
    // è·å– VideoPlaybackQuality
    const quality = this.video.getVideoPlaybackQuality();
    
    this.stats.droppedFrames = quality.droppedVideoFrames;
    this.stats.decodedFrames = quality.totalVideoFrames;
    
    const dropRate = (this.stats.droppedFrames / this.stats.decodedFrames * 100).toFixed(2);
    console.log(`ä¸¢å¸§ç‡: ${dropRate}%`);
    
    // å½“å‰ç ç‡ï¼ˆé€šè¿‡ä¸‹è½½é€Ÿåº¦ä¼°ç®—ï¼‰
    if (this.lastBytes && this.lastTime) {
      const bytes = this.totalBytesDownloaded - this.lastBytes;
      const time = Date.now() - this.lastTime;
      const bitrate = bytes * 8 / time;  // kbps
      
      this.stats.bitrateHistory.push(bitrate);
      console.log(`å½“å‰ç ç‡: ${bitrate.toFixed(0)} kbps`);
    }
    
    this.lastBytes = this.totalBytesDownloaded;
    this.lastTime = Date.now();
  }
}
```

### è‡ªåŠ¨é™çº§ç­–ç•¥

**è‡ªé€‚åº”è´¨é‡è°ƒæ•´**ï¼š
```javascript
class QualityAdapter {
  constructor(player) {
    this.player = player;
    this.currentLevel = 1;  // 0=480p, 1=720p, 2=1080p
    this.levels = [
      { label: '480p', bandwidth: 800000 },
      { label: '720p', bandwidth: 2000000 },
      { label: '1080p', bandwidth: 4000000 }
    ];
  }
  
  adapt() {
    setInterval(() => {
      const stats = this.player.getStats();
      
      // å†³ç­–1ï¼šæ ¹æ®ä¸¢å¸§ç‡
      if (stats.dropRate > 10) {
        // ä¸¢å¸§ç‡é«˜ï¼Œé™çº§
        this.downgrade();
      } else if (stats.dropRate < 1 && stats.bandwidth > this.currentBandwidth * 1.5) {
        // æ€§èƒ½è‰¯å¥½ä¸”å¸¦å®½å……è¶³ï¼Œå‡çº§
        this.upgrade();
      }
      
      // å†³ç­–2ï¼šæ ¹æ®ç¼“å†²åŒº
      if (stats.bufferLength < 2) {
        // ç¼“å†²åŒºä¸è¶³ï¼Œé™çº§
        this.downgrade();
      }
      
      // å†³ç­–3ï¼šæ ¹æ®ç½‘ç»œå¸¦å®½
      if (stats.bandwidth < this.currentBandwidth * 0.8) {
        // å¸¦å®½ä¸è¶³ï¼Œé™çº§
        this.downgrade();
      }
    }, 5000);
  }
  
  downgrade() {
    if (this.currentLevel > 0) {
      this.currentLevel--;
      this.switchLevel(this.currentLevel);
      console.log(`é™çº§åˆ° ${this.levels[this.currentLevel].label}`);
    }
  }
  
  upgrade() {
    if (this.currentLevel < this.levels.length - 1) {
      this.currentLevel++;
      this.switchLevel(this.currentLevel);
      console.log(`å‡çº§åˆ° ${this.levels[this.currentLevel].label}`);
    }
  }
  
  switchLevel(level) {
    const url = `/live/stream_${this.levels[level].label}.flv`;
    this.player.switchURL(url);
  }
}
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. èŠ±å±/é»‘å±

**åŸå› åˆ†æ**ï¼š
```
èŠ±å±çš„æ ¹æœ¬åŸå› ï¼šè§£ç å™¨çŠ¶æ€æ··ä¹±

æ­£å¸¸æƒ…å†µï¼š
I P P P P I P P P
â†‘ è§£ç å™¨ä»è¿™é‡Œé‡ç½®
æ¯ä¸ªGOPä»Iå¸§å¼€å§‹ï¼Œè§£ç å™¨çŠ¶æ€æ­£ç¡®

å¼‚å¸¸æƒ…å†µï¼š
I P P [ä¸¢åŒ…] P I P P P
        â†‘ ä¸¢å¤±äº†På¸§
è§£ç å™¨å°è¯•è§£ç åç»­På¸§
â†’ å‚è€ƒå¸§é”™è¯¯ â†’ èŠ±å±
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šæ£€æµ‹èŠ±å±å¹¶è¯·æ±‚å…³é”®å¸§**
```javascript
class FlowerScreenDetector {
  detectAndRecover(player) {
    setInterval(() => {
      const stats = player.getStats();
      
      // æ£€æµ‹å¼‚å¸¸ï¼šä¸¢å¸§ç‡çªç„¶å‡é«˜
      if (stats.dropRate > 20) {
        console.warn('æ£€æµ‹åˆ°å¯èƒ½çš„èŠ±å±');
        this.requestKeyFrame();
      }
    }, 1000);
  }
  
  requestKeyFrame() {
    // æ–¹æ³•1ï¼šæ–­å¼€é‡è¿ï¼ˆä¼šæ”¶åˆ°GOPç¼“å­˜çš„Iå¸§ï¼‰
    this.player.reconnect();
    
    // æ–¹æ³•2ï¼šé€šè¿‡ä¿¡ä»¤è¯·æ±‚æœåŠ¡å™¨å‘é€PLIï¼ˆPicture Loss Indicationï¼‰
    this.signaling.send({ type: 'request_keyframe' });
  }
}

// æœåŠ¡å™¨ç«¯å¤„ç†
server.on('request_keyframe', (streamId) => {
  // é€šçŸ¥æ¨æµç«¯ç«‹å³ç”ŸæˆIå¸§
  const publisher = getPublisher(streamId);
  publisher.send({ type: 'force_keyframe' });
});

// æ¨æµç«¯å¤„ç†ï¼ˆFFmpegï¼‰
// å‘é€ SIGUSR1 ä¿¡å·å¼ºåˆ¶ç”Ÿæˆå…³é”®å¸§
process.kill(ffmpegProcess.pid, 'SIGUSR1');
```

**æ–¹æ¡ˆ2ï¼šFECï¼ˆå‰å‘çº é”™ï¼‰**
```
åœ¨æ¨æµç«¯æ·»åŠ å†—ä½™æ•°æ®ï¼š
åŸå§‹æ•°æ®ï¼šD1 D2 D3 D4
FECæ•°æ®ï¼š  F1=D1âŠ•D2âŠ•D3âŠ•D4

å‘é€ï¼šD1 D2 D3 D4 F1

è§‚ä¼—ç«¯æ¥æ”¶ï¼šD1 D2 [ä¸¢] D4 F1
æ¢å¤ï¼šD3 = D1âŠ•D2âŠ•D4âŠ•F1

ä¼˜ç‚¹ï¼šæ— éœ€é‡ä¼ ï¼Œå»¶è¿Ÿä½
ç¼ºç‚¹ï¼šå¸¦å®½å¢åŠ  25%
```

---

### 2. éŸ³ç”»ä¸åŒæ­¥

**åŸå› åˆ†æ**ï¼š
```
1. æ—¶é—´æˆ³é”™è¯¯ï¼š
   ç¼–ç å™¨ç”Ÿæˆçš„ PTS ä¸è¿ç»­
   
2. å¸§ç‡æ³¢åŠ¨ï¼š
   å®é™…å¸§ç‡ä¸å£°æ˜å¸§ç‡ä¸ä¸€è‡´
   
3. éŸ³é¢‘ä¸¢å¸§ï¼š
   ç½‘ç»œä¸¢åŒ…å¯¼è‡´éŸ³é¢‘å¸§ç¼ºå¤±
   
4. æ’­æ”¾å™¨åŒæ­¥ç®—æ³•é—®é¢˜ï¼š
   éŸ³è§†é¢‘å‚è€ƒæ—¶é’Ÿä¸ç»Ÿä¸€
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// 1. ä¿®æ­£æ—¶é—´æˆ³
class TimestampCorrector {
  constructor(fps = 30) {
    this.fps = fps;
    this.frameInterval = 1000 / fps;  // ms
    this.lastPTS = 0;
    this.frameCount = 0;
  }
  
  correctVideoPTS(frame) {
    // ç”Ÿæˆè¿ç»­çš„ PTS
    const expectedPTS = this.frameCount * this.frameInterval;
    
    // å¦‚æœå®é™… PTS ä¸é¢„æœŸå·®è·è¿‡å¤§ï¼Œä½¿ç”¨é¢„æœŸå€¼
    if (Math.abs(frame.pts - expectedPTS) > this.frameInterval * 2) {
      console.warn(`æ—¶é—´æˆ³å¼‚å¸¸: ${frame.pts} â†’ ${expectedPTS}`);
      frame.pts = expectedPTS;
    }
    
    this.lastPTS = frame.pts;
    this.frameCount++;
    
    return frame;
  }
}

// 2. éŸ³è§†é¢‘åŒæ­¥
class AVSynchronizer {
  sync(video, audio) {
    // è®¡ç®—éŸ³è§†é¢‘æ—¶é—´å·®
    const videoPTS = video.currentPTS;
    const audioPTS = audio.currentPTS;
    const diff = videoPTS - audioPTS;
    
    if (diff > 100) {
      // è§†é¢‘å¿«äº†ï¼Œä¸¢å¸§
      console.log('è§†é¢‘é¢†å…ˆï¼Œä¸¢å¸§');
      this.dropVideoFrame();
    } else if (diff < -100) {
      // éŸ³é¢‘å¿«äº†ï¼Œé‡å¤å¸§
      console.log('éŸ³é¢‘é¢†å…ˆï¼Œé‡å¤è§†é¢‘å¸§');
      this.repeatVideoFrame();
    }
  }
}
```

---

### 3. å¡é¡¿

**åŸå› åˆ†æ**ï¼š
```
1. ç½‘ç»œå¸¦å®½ä¸è¶³ï¼š
   ç ç‡ 4Mbpsï¼Œä½†ç½‘ç»œåªæœ‰ 2Mbps
   
2. ç¼“å†²åŒºä¸è¶³ï¼š
   æ’­æ”¾å™¨ç¼“å†² < 1ç§’
   
3. è§£ç æ€§èƒ½ä¸è¶³ï¼š
   CPU/GPU æ— æ³•å®æ—¶è§£ç 
   
4. æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼š
   è¿æ¥æ•°è¿‡å¤šå¯¼è‡´å¸¦å®½ä¸è¶³
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// 1. è‡ªé€‚åº”ç ç‡
class AdaptiveBitrate {
  adjust() {
    setInterval(() => {
      const bandwidth = this.estimateBandwidth();
      const currentBitrate = this.player.getCurrentBitrate();
      
      if (bandwidth < currentBitrate * 0.8) {
        // å¸¦å®½ä¸è¶³ï¼Œé™ä½ç ç‡
        this.switchToLowerBitrate();
      } else if (bandwidth > currentBitrate * 1.5) {
        // å¸¦å®½å……è¶³ï¼Œæå‡ç ç‡
        this.switchToHigherBitrate();
      }
    }, 5000);
  }
  
  estimateBandwidth() {
    // åŸºäºä¸‹è½½é€Ÿåº¦ä¼°ç®—
    const bytes = this.totalBytesDownloaded - this.lastBytes;
    const time = Date.now() - this.lastTime;
    return bytes * 8 / time;  // bps
  }
}

// 2. åŠ¨æ€ç¼“å†²
class DynamicBuffer {
  adjust() {
    const bandwidth = this.estimateBandwidth();
    
    if (bandwidth < 1000000) {
      // å¼±ç½‘ï¼Œå¢åŠ ç¼“å†²
      this.player.setBufferLength(5);
    } else {
      // å¼ºç½‘ï¼Œå‡å°‘ç¼“å†²ï¼ˆé™ä½å»¶è¿Ÿï¼‰
      this.player.setBufferLength(2);
    }
  }
}
```

---

### 4. å¯åŠ¨æ…¢

**åŸå› åˆ†æ**ï¼š
```
1. DNS è§£ææ…¢ï¼š
   åŸŸåè§£æè€—æ—¶ 500ms-2s
   
2. TCP è¿æ¥æ…¢ï¼š
   ä¸‰æ¬¡æ¡æ‰‹ï¼ŒRTT Ã— 1.5
   
3. ç­‰å¾…å…³é”®å¸§ï¼š
   æ¥æ”¶æ•°æ®åéœ€ç­‰å¾… I å¸§æ‰èƒ½å¼€å§‹è§£ç 
   
4. ç¼“å†²ç­–ç•¥ï¼š
   æ’­æ”¾å™¨é»˜è®¤ç¼“å†² 3ç§’æ‰å¼€å§‹æ’­æ”¾
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// 1. DNS é¢„è§£æ
<link rel="dns-prefetch" href="//live.example.com">

// 2. HTTP/2 æˆ– QUIC
// HTTP/2 å¤šè·¯å¤ç”¨ï¼Œå‡å°‘è¿æ¥å»ºç«‹æ—¶é—´
// QUIC åŸºäº UDPï¼Œ0-RTT è¿æ¥

// 3. å¯ç”¨ GOP ç¼“å­˜
// æœåŠ¡å™¨ç«¯ç¡®ä¿æ–°è§‚ä¼—ç«‹å³æ”¶åˆ°Iå¸§

// 4. å‡å°‘åˆå§‹ç¼“å†²
const player = new FlvPlayer({
  stashInitialSize: 64,  // 64KB æœ€å°ç¼“å†²
  enableStashBuffer: false
});

// 5. é¢„è¿æ¥
// ç”¨æˆ·ç‚¹å‡»æ’­æ”¾å‰ï¼Œæå‰å»ºç«‹è¿æ¥
button.addEventListener('mouseenter', () => {
  player.preconnect(url);
});
```

---

## æ¶æ„è®¾è®¡å®æˆ˜

### å°å‹ç›´æ’­ï¼ˆ< 1ä¸‡å¹¶å‘ï¼‰

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»æ’­    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ RTMP
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å•å°æœåŠ¡å™¨      â”‚
â”‚  (RTMP + HTTP)   â”‚
â”‚                  â”‚
â”‚  CPU: 8æ ¸        â”‚
â”‚  å†…å­˜: 16GB      â”‚
â”‚  å¸¦å®½: 1Gbps     â”‚
â”‚  æˆæœ¬: $100/æœˆ   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â†’ HTTP-FLV â†’ è§‚ä¼—1-5000
      â””â”€â†’ HLS â†’ è§‚ä¼—5001-10000

æŠ€æœ¯æ ˆï¼š
â”œâ”€â”€ Node-Media-Server (RTMP æ¥æ”¶)
â”œâ”€â”€ Express (HTTP æœåŠ¡)
â””â”€â”€ flv.js / hls.js (æ’­æ”¾å™¨)

å•å°æœåŠ¡å™¨èƒ½åŠ›ï¼š
â”œâ”€â”€ 1080p @ 4Mbps æ¨æµ
â”œâ”€â”€ 10000 å¹¶å‘è§‚ä¼— (HTTP-FLV + HLS æ··åˆ)
â””â”€â”€ å¸¦å®½ï¼š4Mbps Ã— 10000 = 40Gbpsï¼ˆç†è®ºï¼‰
    å®é™…ï¼šä½¿ç”¨ CDN åˆ†æ‹…
```

---

### ä¸­å‹ç›´æ’­ï¼ˆ1ä¸‡ - 10ä¸‡å¹¶å‘ï¼‰

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»æ’­    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ RTMP
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æºç«™æœåŠ¡å™¨      â”‚
â”‚  æ¥æ”¶ + è½¬ç       â”‚
â”‚  (2å°è´Ÿè½½å‡è¡¡)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â†’ 1080p @ 4Mbps â”€â”
        â”œâ”€â†’ 720p @ 2Mbps â”€â”€â”¤
        â””â”€â†’ 480p @ 800Kbps â”˜
                â”‚
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       CDN è¾¹ç¼˜èŠ‚ç‚¹        â”‚
â”‚      (å¤šä¸ªåœ°åŸŸ)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŒ—äº¬ï¼š10000 å¹¶å‘         â”‚
â”‚  ä¸Šæµ·ï¼š20000 å¹¶å‘         â”‚
â”‚  å¹¿å·ï¼š15000 å¹¶å‘         â”‚
â”‚  ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     è§‚ä¼—       â”‚
        â”‚  (10ä¸‡å¹¶å‘)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æˆæœ¬åˆ†æï¼š
â”œâ”€â”€ æºç«™ï¼š$500/æœˆ (2å°æœåŠ¡å™¨)
â”œâ”€â”€ è½¬ç ï¼š$800/æœˆ (3ä¸ªç ç‡)
â”œâ”€â”€ CDNï¼š$2000/æœˆ (100TB æµé‡)
â””â”€â”€ æ€»è®¡ï¼š$3300/æœˆ
```

---

### å¤§å‹ç›´æ’­ï¼ˆ10ä¸‡+ å¹¶å‘ï¼‰

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»æ’­    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ SRT (ä½å»¶è¿Ÿæ¨æµ)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨æµç½‘å…³é›†ç¾¤     â”‚
â”‚  (è´Ÿè½½å‡è¡¡)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è½¬ç é›†ç¾¤        â”‚
â”‚  (åˆ†å¸ƒå¼)         â”‚
â”‚  â”œâ”€ 1080p        â”‚
â”‚  â”œâ”€ 720p         â”‚
â”‚  â”œâ”€ 480p         â”‚
â”‚  â””â”€ 360p         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤šå±‚ CDN         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L1: æºç«™ CDN     â”‚
â”‚  L2: åŒºåŸŸ CDN     â”‚
â”‚  L3: è¾¹ç¼˜ CDN     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â†’ HTTP-FLV (PC) â†’ 50ä¸‡è§‚ä¼—
        â”œâ”€â†’ HLS (ç§»åŠ¨ç«¯) â†’ 80ä¸‡è§‚ä¼—
        â””â”€â†’ WebRTC (äº’åŠ¨) â†’ 1000è§‚ä¼—

æŠ€æœ¯ç»†èŠ‚ï¼š

1. æ™ºèƒ½è°ƒåº¦ï¼š
   â”œâ”€â”€ æ ¹æ®åœ°åŸŸåˆ†é… CDN èŠ‚ç‚¹
   â”œâ”€â”€ æ ¹æ®è®¾å¤‡ç±»å‹åˆ†é…åè®®
   â””â”€â”€ æ ¹æ®å¸¦å®½åˆ†é…ç ç‡

2. å®¹ç¾å¤‡ä»½ï¼š
   â”œâ”€â”€ ä¸»æ¨æµ + å¤‡ç”¨æ¨æµï¼ˆåŒè·¯ï¼‰
   â”œâ”€â”€ å¤šåœ°åŸŸéƒ¨ç½²
   â””â”€â”€ è‡ªåŠ¨æ•…éšœè½¬ç§»

3. ç›‘æ§å‘Šè­¦ï¼š
   â”œâ”€â”€ å®æ—¶ç›‘æ§æ¨æµçŠ¶æ€
   â”œâ”€â”€ å¼‚å¸¸è‡ªåŠ¨å‘Šè­¦
   â””â”€â”€ æ€§èƒ½æŒ‡æ ‡å¤§å±

æˆæœ¬åˆ†æï¼š
â”œâ”€â”€ æœåŠ¡å™¨ï¼š$5000/æœˆ
â”œâ”€â”€ è½¬ç ï¼š$3000/æœˆ
â”œâ”€â”€ CDNï¼š$15000/æœˆ (1PB æµé‡)
â”œâ”€â”€ ç›‘æ§ï¼š$500/æœˆ
â””â”€â”€ æ€»è®¡ï¼š$23500/æœˆ
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ•°æ®æµè½¬ç†è§£**ï¼šä»é‡‡é›†åˆ°æ¸²æŸ“çš„æ¯ä¸ªç¯èŠ‚
2. **å»¶è¿Ÿä¼˜åŒ–**ï¼šGOPã€ç¼–ç å‚æ•°ã€ç¼“å†²ã€è¿½å¸§
3. **æ€§èƒ½ç›‘æ§**ï¼šæŒ‡æ ‡é‡‡é›†ã€å¯è§†åŒ–ã€å‘Šè­¦
4. **é—®é¢˜æ’æŸ¥**ï¼šèŠ±å±ã€å¡é¡¿ã€å»¶è¿Ÿç­‰å¸¸è§é—®é¢˜
5. **æ¶æ„æ¼”è¿›**ï¼šæ ¹æ®è§„æ¨¡é€‰æ‹©åˆé€‚çš„æ¶æ„

### å®æˆ˜å»ºè®®

1. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆè·‘é€šåŸºæœ¬æµç¨‹
2. **é€æ­¥ä¼˜åŒ–**ï¼šæ ¹æ®ç›‘æ§æ•°æ®é’ˆå¯¹æ€§ä¼˜åŒ–
3. **æŒç»­å­¦ä¹ **ï¼šå…³æ³¨æ–°æŠ€æœ¯å’Œæœ€ä½³å®è·µ
4. **ç§¯ç´¯ç»éªŒ**ï¼šè®°å½•é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### å»¶ä¼¸å­¦ä¹ 

- æ·±å…¥å­¦ä¹ è§†é¢‘ç¼–ç åŸç†ï¼ˆH.264/H.265ï¼‰
- ç ”ç©¶ CDN å·¥ä½œåŸç†å’Œè°ƒåº¦ç®—æ³•
- å­¦ä¹  WebRTC çš„ P2P å’Œ SFU æ¶æ„
- äº†è§£ AI åœ¨ç›´æ’­ä¸­çš„åº”ç”¨ï¼ˆè¶…åˆ†ã€ç¾é¢œï¼‰

å®Œæ•´çš„å®æˆ˜æŒ‡å—åˆ°æ­¤ç»“æŸï¼ğŸ‰

