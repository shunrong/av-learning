# 🚀 04 HLS 项目启动指南

## 快速启动（3个终端）

### 终端 1：启动 04 服务器

```bash
cd 04-hls-live-streaming
npm start
```

✅ 看到启动成功信息即可

---

### 终端 2：启动推流客户端

```bash
cd ../03-live-streaming-basic/publisher
npm start
```

浏览器会自动打开 `http://localhost:3002`

操作：
1. 选择推流源（摄像头或本地视频）
2. 点击"开始推流"
3. 等待显示"推流中"

---

### 终端 3：启动 HLS 转码

**方式A：使用脚本（推荐）**

```bash
cd 04-hls-live-streaming
./start-hls-transcode.sh
```

**方式B：手动命令**

```bash
cd 04-hls-live-streaming

# 创建输出目录
mkdir -p media/live/stream

# 启动转码
ffmpeg -i rtmp://localhost:1935/live/stream \
  -c copy \
  -f hls \
  -hls_time 6 \
  -hls_list_size 10 \
  -hls_flags delete_segments \
  -hls_segment_filename 'media/live/stream/segment_%d.ts' \
  media/live/stream/index.m3u8
```

✅ 看到 FFmpeg 输出信息，并开始生成切片文件

---

### 浏览器：观看直播

打开：http://localhost:3000/player.html

操作：
1. 点击"▶ 开始播放"
2. **等待 6-12 秒**（HLS 需要生成足够的切片）
3. 开始播放！

---

## ✅ 检查清单

在观看前，确保：

- [ ] 终端1：服务器显示"启动成功"
- [ ] 终端2：推流客户端显示"推流中"
- [ ] 终端3：FFmpeg 显示正在转码（有帧数输出）
- [ ] `media/live/stream/` 目录下有 `.ts` 和 `.m3u8` 文件

检查文件：
```bash
ls -lh media/live/stream/
```

应该看到：
```
index.m3u8
segment_0.ts
segment_1.ts
segment_2.ts
...
```

---

## ❓ 常见问题

### 1. 播放黑屏？

**原因**：切片还没生成够

**解决**：
1. 等待 6-12 秒
2. 检查 `media/live/stream/` 是否有文件
3. 刷新播放器重试

---

### 2. FFmpeg 报错 "Connection refused"？

**原因**：推流还没开始

**解决**：
1. 先启动推流客户端（终端2）
2. 确认推流成功
3. 再启动 FFmpeg 转码（终端3）

---

### 3. 看不到切片文件？

**检查**：
```bash
# 查看实时生成
watch -n 1 ls -lh media/live/stream/

# 查看 m3u8 内容
cat media/live/stream/index.m3u8
```

如果没有文件：
1. 检查 FFmpeg 是否有错误输出
2. 确认推流地址正确：`rtmp://localhost:1935/live/stream`
3. 检查权限：`ls -ld media/live/stream/`

---

### 4. 端口冲突？

**1935 端口被占用**：
```bash
# 查看占用进程
lsof -i :1935

# 关闭进程
kill -9 <PID>
```

**3000 端口被占用**：
修改 `server/server.js` 中的 `HTTP_PORT`

---

## 🎯 启动顺序总结

```
正确顺序：
1️⃣ 04 服务器 → 2️⃣ 推流客户端 → 3️⃣ HLS 转码 → 4️⃣ 播放器

错误顺序：
❌ 先启动转码（推流还没开始，会报错）
❌ 不启动转码（没有 HLS 文件，无法播放）
```

---

## 💡 停止服务

```bash
# 终端1（04服务器）：Ctrl + C
# 终端2（推流客户端）：在网页上点击"停止推流"
# 终端3（FFmpeg转码）：Ctrl + C
```

---

## 🔍 调试技巧

### 查看 m3u8 实时更新

```bash
watch -n 1 cat media/live/stream/index.m3u8
```

### 查看 TS 文件信息

```bash
ffprobe media/live/stream/segment_0.ts
```

### 手动测试播放

```bash
# 使用 FFplay
ffplay http://localhost:8080/live/stream/index.m3u8

# 使用 VLC
open -a VLC http://localhost:8080/live/stream/index.m3u8
```

---

现在你可以开始体验 HLS 直播了！🎉

