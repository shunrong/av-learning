<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HLS æ’­æ”¾å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 2em;
    }
    
    .player-container {
      position: relative;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    video {
      width: 100%;
      display: block;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }
    
    .btn-secondary:hover {
      background: #cbd5e0;
    }
    
    .btn-danger {
      background: #fc8181;
      color: white;
    }
    
    .btn-danger:hover {
      background: #f56565;
    }
    
    .stats {
      background: #f7fafc;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .stats h3 {
      color: #2d3748;
      margin-bottom: 15px;
    }
    
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .stat-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #718096;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #2d3748;
    }
    
    .info {
      background: #bee3f8;
      border-left: 4px solid #3182ce;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .warning {
      background: #feebc8;
      border-left: 4px solid #dd6b20;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .success {
      background: #c6f6d5;
      border-left: 4px solid #38a169;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .error {
      background: #fed7d7;
      border-left: 4px solid #e53e3e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .log {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.85em;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .log-item {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .log-time {
      color: #90cdf4;
      margin-right: 10px;
    }
    
    .back-link {
      display: inline-block;
      color: #667eea;
      text-decoration: none;
      margin-bottom: 20px;
      font-weight: bold;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
    
    <h1>ğŸ“º HLS æ’­æ”¾å™¨</h1>
    
    <div id="status" class="info">
      â„¹ï¸ ç­‰å¾…æ’­æ”¾... è¯·ç¡®ä¿æ¨æµå·²å¼€å§‹
    </div>
    
    <div class="player-container">
      <video id="video" controls muted></video>
    </div>
    
    <div class="controls">
      <button class="btn-primary" onclick="play()">â–¶ å¼€å§‹æ’­æ”¾</button>
      <button class="btn-secondary" onclick="pause()">â¸ æš‚åœ</button>
      <button class="btn-secondary" onclick="reload()">ğŸ”„ é‡æ–°åŠ è½½</button>
      <button class="btn-secondary" onclick="toggleMute()">ğŸ”‡ é™éŸ³/å–æ¶ˆé™éŸ³</button>
      <button class="btn-danger" onclick="stop()">â¹ åœæ­¢</button>
    </div>
    
    <div class="stats">
      <h3>ğŸ“Š æ’­æ”¾ç»Ÿè®¡</h3>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-label">å½“å‰çŠ¶æ€</div>
          <div class="stat-value" id="status-text">æœªæ’­æ”¾</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å½“å‰æ—¶é—´</div>
          <div class="stat-value" id="current-time">0:00</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ç¼“å†²é•¿åº¦</div>
          <div class="stat-value" id="buffer-length">0s</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">åŠ è½½çš„åˆ‡ç‰‡</div>
          <div class="stat-value" id="fragments-loaded">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å¡é¡¿æ¬¡æ•°</div>
          <div class="stat-value" id="stall-count">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">é”™è¯¯æ¬¡æ•°</div>
          <div class="stat-value" id="error-count">0</div>
        </div>
      </div>
    </div>
    
    <div class="stats">
      <h3>ğŸ“ äº‹ä»¶æ—¥å¿—</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    
    // HLS æ’­æ”¾åœ°å€
    const HLS_URL = 'http://localhost:8080/live/stream/index.m3u8';
    
    let hls = null;
    let stallCount = 0;
    let errorCount = 0;
    let fragmentsLoaded = 0;
    
    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const logItem = document.createElement('div');
      logItem.className = 'log-item';
      logItem.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      logDiv.insertBefore(logItem, logDiv.firstChild);
      
      // ä¿æŒæœ€å¤š 50 æ¡æ—¥å¿—
      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.lastChild);
      }
    }
    
    // æ›´æ–°çŠ¶æ€
    function updateStatus(message, type = 'info') {
      statusDiv.className = type;
      statusDiv.innerHTML = getIcon(type) + ' ' + message;
    }
    
    function getIcon(type) {
      const icons = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        warning: 'âš ï¸',
        error: 'âŒ'
      };
      return icons[type] || 'â„¹ï¸';
    }
    
    // åˆå§‹åŒ– HLS
    function initHLS() {
      if (Hls.isSupported()) {
        addLog('HLS.js åˆå§‹åŒ–ä¸­...');
        
        hls = new Hls({
          // ä½å»¶è¿Ÿé…ç½®
          maxBufferLength: 10,           // æœ€å¤§ç¼“å†² 10 ç§’
          maxMaxBufferLength: 30,        // æé™ç¼“å†² 30 ç§’
          liveSyncDurationCount: 1,      // åªç¼“å†² 1 ä¸ªåˆ‡ç‰‡ï¼ˆä½å»¶è¿Ÿï¼‰
          liveMaxLatencyDurationCount: 3,// æœ€å¤§ 3 ä¸ªåˆ‡ç‰‡
          enableWorker: true,            // å¯ç”¨ Workerï¼ˆæ€§èƒ½ï¼‰
          
          // è°ƒè¯•
          debug: false
        });
        
        hls.loadSource(HLS_URL);
        hls.attachMedia(video);
        
        // HLS.js äº‹ä»¶ç›‘å¬
        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
          addLog(`âœ… m3u8 è§£ææˆåŠŸï¼Œå…± ${data.levels.length} ä¸ªç ç‡`);
          updateStatus('m3u8 åŠ è½½æˆåŠŸï¼Œå‡†å¤‡æ’­æ”¾', 'success');
          document.getElementById('status-text').textContent = 'å°±ç»ª';
        });
        
        hls.on(Hls.Events.MANIFEST_LOADING, () => {
          addLog('ğŸ“¥ æ­£åœ¨åŠ è½½ m3u8...');
          updateStatus('æ­£åœ¨åŠ è½½æ’­æ”¾åˆ—è¡¨...', 'info');
        });
        
        hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
          fragmentsLoaded++;
          addLog(`ğŸ“¦ åˆ‡ç‰‡åŠ è½½å®Œæˆ: ${data.frag.relurl} (${(data.frag.duration).toFixed(2)}s)`);
          document.getElementById('fragments-loaded').textContent = fragmentsLoaded;
        });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
          errorCount++;
          document.getElementById('error-count').textContent = errorCount;
          
          if (data.fatal) {
            addLog(`âŒ è‡´å‘½é”™è¯¯: ${data.type} - ${data.details}`, 'error');
            updateStatus(`è‡´å‘½é”™è¯¯: ${data.details}`, 'error');
            
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                addLog('ğŸ”„ å°è¯•æ¢å¤ç½‘ç»œé”™è¯¯...');
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                addLog('ğŸ”„ å°è¯•æ¢å¤åª’ä½“é”™è¯¯...');
                hls.recoverMediaError();
                break;
              default:
                addLog('ğŸ’¥ æ— æ³•æ¢å¤ï¼Œé”€æ¯æ’­æ”¾å™¨');
                hls.destroy();
                break;
            }
          } else {
            addLog(`âš ï¸ éè‡´å‘½é”™è¯¯: ${data.details}`, 'warning');
          }
        });
        
        addLog('âœ… HLS.js åˆå§‹åŒ–å®Œæˆ');
        
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari åŸç”Ÿæ”¯æŒ HLS
        addLog('ğŸ“± Safari åŸç”Ÿ HLS æ’­æ”¾');
        video.src = HLS_URL;
        updateStatus('ä½¿ç”¨ Safari åŸç”Ÿ HLS', 'success');
        
      } else {
        updateStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾', 'error');
        addLog('âŒ æµè§ˆå™¨ä¸æ”¯æŒ HLSï¼Œè¯·ä½¿ç”¨ Chrome/Firefox/Safari');
      }
    }
    
    // æ’­æ”¾æ§åˆ¶
    function play() {
      if (!hls) {
        initHLS();
      }
      video.play().then(() => {
        addLog('â–¶ å¼€å§‹æ’­æ”¾');
        updateStatus('æ­£åœ¨æ’­æ”¾...', 'success');
        document.getElementById('status-text').textContent = 'æ’­æ”¾ä¸­';
      }).catch(err => {
        addLog(`âŒ æ’­æ”¾å¤±è´¥: ${err.message}`, 'error');
        updateStatus(`æ’­æ”¾å¤±è´¥: ${err.message}`, 'error');
      });
    }
    
    function pause() {
      video.pause();
      addLog('â¸ æš‚åœæ’­æ”¾');
      document.getElementById('status-text').textContent = 'æš‚åœ';
    }
    
    function stop() {
      video.pause();
      video.currentTime = 0;
      if (hls) {
        hls.destroy();
        hls = null;
      }
      addLog('â¹ åœæ­¢æ’­æ”¾');
      updateStatus('å·²åœæ­¢', 'info');
      document.getElementById('status-text').textContent = 'å·²åœæ­¢';
    }
    
    function reload() {
      addLog('ğŸ”„ é‡æ–°åŠ è½½...');
      if (hls) {
        hls.destroy();
      }
      fragmentsLoaded = 0;
      initHLS();
      setTimeout(() => play(), 500);
    }
    
    function toggleMute() {
      video.muted = !video.muted;
      addLog(video.muted ? 'ğŸ”‡ å·²é™éŸ³' : 'ğŸ”Š å–æ¶ˆé™éŸ³');
    }
    
    // è§†é¢‘äº‹ä»¶ç›‘å¬
    video.addEventListener('loadstart', () => {
      addLog('ğŸ”„ å¼€å§‹åŠ è½½è§†é¢‘');
    });
    
    video.addEventListener('loadedmetadata', () => {
      addLog(`ğŸ“¹ å…ƒæ•°æ®åŠ è½½å®Œæˆ (${video.videoWidth}x${video.videoHeight})`);
    });
    
    video.addEventListener('playing', () => {
      addLog('â–¶ è§†é¢‘å¼€å§‹æ’­æ”¾');
      document.getElementById('status-text').textContent = 'æ’­æ”¾ä¸­';
    });
    
    video.addEventListener('waiting', () => {
      stallCount++;
      addLog('â³ ç¼“å†²ä¸­...');
      document.getElementById('stall-count').textContent = stallCount;
    });
    
    video.addEventListener('stalled', () => {
      addLog('âš ï¸ æ’­æ”¾å¡é¡¿', 'warning');
    });
    
    video.addEventListener('ended', () => {
      addLog('ğŸ æ’­æ”¾ç»“æŸ');
    });
    
    video.addEventListener('error', (e) => {
      addLog(`âŒ è§†é¢‘é”™è¯¯: ${e.message}`, 'error');
      updateStatus(`è§†é¢‘é”™è¯¯: ${e.message}`, 'error');
    });
    
    // å®šæ—¶æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    setInterval(() => {
      if (!video.paused) {
        // å½“å‰æ—¶é—´
        const currentTime = video.currentTime;
        const minutes = Math.floor(currentTime / 60);
        const seconds = Math.floor(currentTime % 60);
        document.getElementById('current-time').textContent = 
          `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // ç¼“å†²é•¿åº¦
        if (video.buffered.length > 0) {
          const buffered = video.buffered.end(0) - currentTime;
          document.getElementById('buffer-length').textContent = 
            buffered.toFixed(1) + 's';
        }
      }
    }, 1000);
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', () => {
      addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
      updateStatus('å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ’­æ”¾"æŒ‰é’®', 'info');
    });
  </script>
</body>
</html>

