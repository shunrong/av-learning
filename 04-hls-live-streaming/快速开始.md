# 04 HLS 直播系统 - 快速开始

## 🎯 5分钟快速体验

### 第一步：安装依赖

```bash
cd 04-hls-live-streaming
npm install
```

### 第二步：启动服务器

```bash
npm start
```

你会看到：
```
╔═══════════════════════════════════════════════════════╗
║        🎥  HLS 直播服务器启动成功！                   ║
╚═══════════════════════════════════════════════════════╝

📌 服务信息：
   RTMP 推流端口: 1935
   HTTP 服务端口: 8080 (HLS 文件)
   Web 服务端口: 3000

🌐 访问地址：
   首页: http://localhost:3000
   播放器: http://localhost:3000/player.html
```

### 第三步：推流

**方式A：复用 03 项目的推流客户端（推荐）**

新开终端：
```bash
cd ../03-live-streaming-basic/publisher
npm start

# 访问 http://localhost:3002
# 使用推流客户端推流（摄像头或本地视频）
```

**方式B：使用 FFmpeg 命令行推流**

测试视频推流：
```bash
ffmpeg -re -i test.mp4 -c copy -f flv rtmp://localhost:1935/live/stream
```

摄像头推流（Mac）：
```bash
ffmpeg -f avfoundation -i "0:0" \
  -c:v libx264 -preset veryfast -b:v 2000k \
  -c:a aac -b:a 128k \
  -f flv rtmp://localhost:1935/live/stream
```

### 第四步：观看直播

1. 打开浏览器：http://localhost:3000/player.html
2. 点击"开始播放"
3. **等待 6-12 秒**（HLS 需要生成切片）
4. 开始播放！

---

## 📊 对比 HTTP-FLV

想直观对比 HTTP-FLV 和 HLS 的差异？

### 方式1：同时运行两个服务器

**终端1：启动 03 项目（HTTP-FLV）**
```bash
cd 03-live-streaming-basic
npm start  # 端口 3001
```

**终端2：启动 04 项目（HLS）**
```bash
cd 04-hls-live-streaming
npm start  # 端口 3000
```

**终端3：推流（两个服务器共用）**
```bash
cd 03-live-streaming-basic/publisher
npm start
# 推流到 rtmp://localhost:1935/live/stream
```

**浏览器：打开对比页面**
```
http://localhost:3000/compare.html
```

同时播放两个协议，实时对比！

---

## 🔧 常见问题

### 1. 播放黑屏？

**原因**：HLS 需要生成切片，有启动延迟

**解决**：
1. 确认推流已开始（服务器终端有"推流开始"日志）
2. 等待 6-12 秒（生成 1-2 个切片）
3. 重新点击"开始播放"

### 2. FFmpeg 路径错误？

**错误信息**：
```
Error: spawn /opt/homebrew/bin/ffmpeg ENOENT
```

**解决**：
修改 `server/server.js` 中的 FFmpeg 路径：

```javascript
trans: {
  ffmpeg: '/usr/local/bin/ffmpeg',  // 或其他路径
  // ...
}
```

查找 FFmpeg 路径：
```bash
which ffmpeg
```

### 3. 端口冲突？

**错误信息**：
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决**：
修改 `server/server.js` 中的端口：
```javascript
const HTTP_PORT = 3001;  // 改成其他端口
```

### 4. 看不到 m3u8 或 TS 文件？

**检查路径**：
```bash
ls -la media/live/stream/
```

应该看到：
```
index.m3u8
segment_0.ts
segment_1.ts
...
```

如果没有，检查：
1. FFmpeg 是否正确安装
2. 推流是否成功
3. 服务器日志是否有错误

---

## 📝 重要概念

### HLS 工作流程

```
推流 → RTMP → 服务器 → FFmpeg 切片 → HLS 文件
                        ↓
                  index.m3u8 (播放列表)
                  segment_0.ts (切片1)
                  segment_1.ts (切片2)
                  ...
```

### 切片参数

```javascript
hlsFlags: '[hls_time=6:hls_list_size=10:hls_flags=delete_segments]'
```

- `hls_time=6`: 每个切片 6 秒
- `hls_list_size=10`: m3u8 中保留 10 个切片
- `hls_flags=delete_segments`: 自动删除旧切片

**延迟分析**：
- 切片时长：6 秒
- 播放器缓冲：2 个切片 = 12 秒
- 网络延迟：1-2 秒
- **总延迟：~15-20 秒**

### HTTP-FLV vs HLS

|  维度  | HTTP-FLV | HLS |
|--------|----------|-----|
| 延迟 | 3-5秒 | 15-20秒 |
| 兼容性 | 需要 MSE | 移动端原生支持 |
| CDN | 一般 | 优秀 |
| 复杂度 | 简单 | 中等 |
| 适用场景 | PC 互动直播 | 移动端、大规模分发 |

---

## 🎓 下一步学习

完成基础体验后，按顺序深入：

### Week 1-2: 理解 HLS 格式
- 📖 查看 m3u8 文件内容
- 🔬 分析 TS 切片结构
- 📊 对比不同切片时长的效果

### Week 3-4: 多码率实现
- 🎯 实现多码率转码
- 📈 测试自适应切换
- 💰 分析带宽成本

### Week 5-6: 性能优化
- ⚡ 降低启动延迟
- 📉 减少卡顿次数
- 📊 完整性能测试报告

### Week 7-8: LL-HLS（可选）
- 🚀 Low Latency HLS
- 📦 部分切片实现
- ⏱️ 延迟降低到 3-5 秒

---

## 💡 实用技巧

### 查看 m3u8 内容

```bash
# 实时查看 m3u8 更新
watch -n 1 cat media/live/stream/index.m3u8
```

### 查看 TS 文件信息

```bash
ffprobe media/live/stream/segment_0.ts
```

### 手动测试 HLS

```bash
# 使用 curl 下载 m3u8
curl http://localhost:8080/live/stream/index.m3u8

# 使用 FFmpeg 播放 HLS
ffplay http://localhost:8080/live/stream/index.m3u8
```

---

开始你的 HLS 学习之旅吧！🚀

有问题随时查看主 README 或提问。

