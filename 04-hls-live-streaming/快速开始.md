# 04 HLS ç›´æ’­ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹

## ğŸ¯ 5åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
cd 04-hls-live-streaming
npm install
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æœåŠ¡å™¨

```bash
npm start
```

ä½ ä¼šçœ‹åˆ°ï¼š
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        ğŸ¥  HLS ç›´æ’­æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ æœåŠ¡ä¿¡æ¯ï¼š
   RTMP æ¨æµç«¯å£: 1935
   HTTP æœåŠ¡ç«¯å£: 8080 (HLS æ–‡ä»¶)
   Web æœåŠ¡ç«¯å£: 3000

ğŸŒ è®¿é—®åœ°å€ï¼š
   é¦–é¡µ: http://localhost:3000
   æ’­æ”¾å™¨: http://localhost:3000/player.html
```

### ç¬¬ä¸‰æ­¥ï¼šæ¨æµ

**æ–¹å¼Aï¼šå¤ç”¨ 03 é¡¹ç›®çš„æ¨æµå®¢æˆ·ç«¯ï¼ˆæ¨èï¼‰**

æ–°å¼€ç»ˆç«¯ï¼š
```bash
cd ../03-live-streaming-basic/publisher
npm start

# è®¿é—® http://localhost:3002
# ä½¿ç”¨æ¨æµå®¢æˆ·ç«¯æ¨æµï¼ˆæ‘„åƒå¤´æˆ–æœ¬åœ°è§†é¢‘ï¼‰
```

**æ–¹å¼Bï¼šä½¿ç”¨ FFmpeg å‘½ä»¤è¡Œæ¨æµ**

æµ‹è¯•è§†é¢‘æ¨æµï¼š
```bash
ffmpeg -re -i test.mp4 -c copy -f flv rtmp://localhost:1935/live/stream
```

æ‘„åƒå¤´æ¨æµï¼ˆMacï¼‰ï¼š
```bash
ffmpeg -f avfoundation -i "0:0" \
  -c:v libx264 -preset veryfast -b:v 2000k \
  -c:a aac -b:a 128k \
  -f flv rtmp://localhost:1935/live/stream
```

### ç¬¬å››æ­¥ï¼šè§‚çœ‹ç›´æ’­

1. æ‰“å¼€æµè§ˆå™¨ï¼šhttp://localhost:3000/player.html
2. ç‚¹å‡»"å¼€å§‹æ’­æ”¾"
3. **ç­‰å¾… 6-12 ç§’**ï¼ˆHLS éœ€è¦ç”Ÿæˆåˆ‡ç‰‡ï¼‰
4. å¼€å§‹æ’­æ”¾ï¼

---

## ğŸ“Š å¯¹æ¯” HTTP-FLV

æƒ³ç›´è§‚å¯¹æ¯” HTTP-FLV å’Œ HLS çš„å·®å¼‚ï¼Ÿ

### æ–¹å¼1ï¼šåŒæ—¶è¿è¡Œä¸¤ä¸ªæœåŠ¡å™¨

**ç»ˆç«¯1ï¼šå¯åŠ¨ 03 é¡¹ç›®ï¼ˆHTTP-FLVï¼‰**
```bash
cd 03-live-streaming-basic
npm start  # ç«¯å£ 3001
```

**ç»ˆç«¯2ï¼šå¯åŠ¨ 04 é¡¹ç›®ï¼ˆHLSï¼‰**
```bash
cd 04-hls-live-streaming
npm start  # ç«¯å£ 3000
```

**ç»ˆç«¯3ï¼šæ¨æµï¼ˆä¸¤ä¸ªæœåŠ¡å™¨å…±ç”¨ï¼‰**
```bash
cd 03-live-streaming-basic/publisher
npm start
# æ¨æµåˆ° rtmp://localhost:1935/live/stream
```

**æµè§ˆå™¨ï¼šæ‰“å¼€å¯¹æ¯”é¡µé¢**
```
http://localhost:3000/compare.html
```

åŒæ—¶æ’­æ”¾ä¸¤ä¸ªåè®®ï¼Œå®æ—¶å¯¹æ¯”ï¼

---

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. æ’­æ”¾é»‘å±ï¼Ÿ

**åŸå› **ï¼šHLS éœ€è¦ç”Ÿæˆåˆ‡ç‰‡ï¼Œæœ‰å¯åŠ¨å»¶è¿Ÿ

**è§£å†³**ï¼š
1. ç¡®è®¤æ¨æµå·²å¼€å§‹ï¼ˆæœåŠ¡å™¨ç»ˆç«¯æœ‰"æ¨æµå¼€å§‹"æ—¥å¿—ï¼‰
2. ç­‰å¾… 6-12 ç§’ï¼ˆç”Ÿæˆ 1-2 ä¸ªåˆ‡ç‰‡ï¼‰
3. é‡æ–°ç‚¹å‡»"å¼€å§‹æ’­æ”¾"

### 2. FFmpeg è·¯å¾„é”™è¯¯ï¼Ÿ

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error: spawn /opt/homebrew/bin/ffmpeg ENOENT
```

**è§£å†³**ï¼š
ä¿®æ”¹ `server/server.js` ä¸­çš„ FFmpeg è·¯å¾„ï¼š

```javascript
trans: {
  ffmpeg: '/usr/local/bin/ffmpeg',  // æˆ–å…¶ä»–è·¯å¾„
  // ...
}
```

æŸ¥æ‰¾ FFmpeg è·¯å¾„ï¼š
```bash
which ffmpeg
```

### 3. ç«¯å£å†²çªï¼Ÿ

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error: listen EADDRINUSE: address already in use :::3000
```

**è§£å†³**ï¼š
ä¿®æ”¹ `server/server.js` ä¸­çš„ç«¯å£ï¼š
```javascript
const HTTP_PORT = 3001;  // æ”¹æˆå…¶ä»–ç«¯å£
```

### 4. çœ‹ä¸åˆ° m3u8 æˆ– TS æ–‡ä»¶ï¼Ÿ

**æ£€æŸ¥è·¯å¾„**ï¼š
```bash
ls -la media/live/stream/
```

åº”è¯¥çœ‹åˆ°ï¼š
```
index.m3u8
segment_0.ts
segment_1.ts
...
```

å¦‚æœæ²¡æœ‰ï¼Œæ£€æŸ¥ï¼š
1. FFmpeg æ˜¯å¦æ­£ç¡®å®‰è£…
2. æ¨æµæ˜¯å¦æˆåŠŸ
3. æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

---

## ğŸ“ é‡è¦æ¦‚å¿µ

### HLS å·¥ä½œæµç¨‹

```
æ¨æµ â†’ RTMP â†’ æœåŠ¡å™¨ â†’ FFmpeg åˆ‡ç‰‡ â†’ HLS æ–‡ä»¶
                        â†“
                  index.m3u8 (æ’­æ”¾åˆ—è¡¨)
                  segment_0.ts (åˆ‡ç‰‡1)
                  segment_1.ts (åˆ‡ç‰‡2)
                  ...
```

### åˆ‡ç‰‡å‚æ•°

```javascript
hlsFlags: '[hls_time=6:hls_list_size=10:hls_flags=delete_segments]'
```

- `hls_time=6`: æ¯ä¸ªåˆ‡ç‰‡ 6 ç§’
- `hls_list_size=10`: m3u8 ä¸­ä¿ç•™ 10 ä¸ªåˆ‡ç‰‡
- `hls_flags=delete_segments`: è‡ªåŠ¨åˆ é™¤æ—§åˆ‡ç‰‡

**å»¶è¿Ÿåˆ†æ**ï¼š
- åˆ‡ç‰‡æ—¶é•¿ï¼š6 ç§’
- æ’­æ”¾å™¨ç¼“å†²ï¼š2 ä¸ªåˆ‡ç‰‡ = 12 ç§’
- ç½‘ç»œå»¶è¿Ÿï¼š1-2 ç§’
- **æ€»å»¶è¿Ÿï¼š~15-20 ç§’**

### HTTP-FLV vs HLS

|  ç»´åº¦  | HTTP-FLV | HLS |
|--------|----------|-----|
| å»¶è¿Ÿ | 3-5ç§’ | 15-20ç§’ |
| å…¼å®¹æ€§ | éœ€è¦ MSE | ç§»åŠ¨ç«¯åŸç”Ÿæ”¯æŒ |
| CDN | ä¸€èˆ¬ | ä¼˜ç§€ |
| å¤æ‚åº¦ | ç®€å• | ä¸­ç­‰ |
| é€‚ç”¨åœºæ™¯ | PC äº’åŠ¨ç›´æ’­ | ç§»åŠ¨ç«¯ã€å¤§è§„æ¨¡åˆ†å‘ |

---

## ğŸ“ ä¸‹ä¸€æ­¥å­¦ä¹ 

å®ŒæˆåŸºç¡€ä½“éªŒåï¼ŒæŒ‰é¡ºåºæ·±å…¥ï¼š

### Week 1-2: ç†è§£ HLS æ ¼å¼
- ğŸ“– æŸ¥çœ‹ m3u8 æ–‡ä»¶å†…å®¹
- ğŸ”¬ åˆ†æ TS åˆ‡ç‰‡ç»“æ„
- ğŸ“Š å¯¹æ¯”ä¸åŒåˆ‡ç‰‡æ—¶é•¿çš„æ•ˆæœ

### Week 3-4: å¤šç ç‡å®ç°
- ğŸ¯ å®ç°å¤šç ç‡è½¬ç 
- ğŸ“ˆ æµ‹è¯•è‡ªé€‚åº”åˆ‡æ¢
- ğŸ’° åˆ†æå¸¦å®½æˆæœ¬

### Week 5-6: æ€§èƒ½ä¼˜åŒ–
- âš¡ é™ä½å¯åŠ¨å»¶è¿Ÿ
- ğŸ“‰ å‡å°‘å¡é¡¿æ¬¡æ•°
- ğŸ“Š å®Œæ•´æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

### Week 7-8: LL-HLSï¼ˆå¯é€‰ï¼‰
- ğŸš€ Low Latency HLS
- ğŸ“¦ éƒ¨åˆ†åˆ‡ç‰‡å®ç°
- â±ï¸ å»¶è¿Ÿé™ä½åˆ° 3-5 ç§’

---

## ğŸ’¡ å®ç”¨æŠ€å·§

### æŸ¥çœ‹ m3u8 å†…å®¹

```bash
# å®æ—¶æŸ¥çœ‹ m3u8 æ›´æ–°
watch -n 1 cat media/live/stream/index.m3u8
```

### æŸ¥çœ‹ TS æ–‡ä»¶ä¿¡æ¯

```bash
ffprobe media/live/stream/segment_0.ts
```

### æ‰‹åŠ¨æµ‹è¯• HLS

```bash
# ä½¿ç”¨ curl ä¸‹è½½ m3u8
curl http://localhost:8080/live/stream/index.m3u8

# ä½¿ç”¨ FFmpeg æ’­æ”¾ HLS
ffplay http://localhost:8080/live/stream/index.m3u8
```

---

å¼€å§‹ä½ çš„ HLS å­¦ä¹ ä¹‹æ—…å§ï¼ğŸš€

æœ‰é—®é¢˜éšæ—¶æŸ¥çœ‹ä¸» README æˆ–æé—®ã€‚

